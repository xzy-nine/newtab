name: ç‰ˆæœ¬æ£€æŸ¥ä¸Žæž„å»º
on:
  push:
    branches:
      - main  
  workflow_call:
    outputs:
      version:
        description: "å½“å‰ç‰ˆæœ¬å·"
        value: ${{ jobs.version-check-and-build.outputs.version }}
      is_new_version:
        description: "æ˜¯å¦ä¸ºæ–°ç‰ˆæœ¬"
        value: ${{ jobs.version-check-and-build.outputs.is_new_version }}
      tag_exists:
        description: "ç‰ˆæœ¬æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨"
        value: ${{ jobs.version-check-and-build.outputs.tag_exists }}
      changelog:
        description: "ç”Ÿæˆçš„å˜æ›´æ—¥å¿—"
        value: ${{ jobs.version-check-and-build.outputs.changelog }}
      build_path:
        description: "æž„å»ºåŒ…çš„è·¯å¾„"
        value: ${{ jobs.version-check-and-build.outputs.build_path }}

jobs:  
  version-check-and-build:
    name: ç‰ˆæœ¬æ£€æŸ¥ä¸Žæž„å»º
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is_new_version: ${{ steps.compare-versions.outputs.is_new_version }}
      tag_exists: ${{ steps.check-tag-exists.outputs.tag_exists }}
      changelog: ${{ steps.generate-changelog.outputs.changelog }}
      build_path: ${{ steps.create-build-package.outputs.build_path }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ä»Žmanifest.jsonèŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: get-version
      run: |
        VERSION=$(jq -r '.version' manifest.json)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ å½“å‰ç‰ˆæœ¬: $VERSION"

    - name: èŽ·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬
      id: get-latest-release
      run: |
        LATEST_VERSION=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name // "0.0.0"')
        echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_ENV
        echo "ðŸ“‹ æœ€æ–°å‘å¸ƒç‰ˆæœ¬: $LATEST_VERSION"

    - name: æ¯”è¾ƒç‰ˆæœ¬æ ‡ç­¾
      id: compare-versions
      run: |
        if [ "$(printf '%s\n' "$LATEST_VERSION" "$VERSION" | sort -rV | head -n1)" = "$VERSION" ]; then
            echo "new_version=true" >> $GITHUB_ENV
            echo "âœ… æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: $VERSION"
        else
            echo "new_version=false" >> $GITHUB_ENV
            echo "â„¹ï¸ ç‰ˆæœ¬æœªæ›´æ–°ï¼Œå½“å‰ç‰ˆæœ¬: $VERSIONï¼Œæœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
        fi

    - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
      id: check-tag-exists
      run: |
        if git rev-parse "refs/tags/${{ env.VERSION }}" >/dev/null 2>&1; then
          echo "tag_exists=true" >> $GITHUB_ENV
          echo "âš ï¸ æ ‡ç­¾ ${{ env.VERSION }} å·²å­˜åœ¨"
        else
          echo "tag_exists=false" >> $GITHUB_ENV
          echo "âœ… æ ‡ç­¾ ${{ env.VERSION }} ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»º"
        fi

    - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: generate-changelog
      if: env.new_version == 'true' && env.tag_exists == 'false'
      run: |
        echo "ðŸ“ å¼€å§‹ç”Ÿæˆå˜æ›´æ—¥å¿—..."
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          echo "ðŸ“‹ é¦–æ¬¡å‘å¸ƒï¼ŒèŽ·å–æ‰€æœ‰æäº¤è®°å½•"
          CHANGELOG=$(git log --pretty=format:"%h - %s")
        else
          echo "ðŸ“‹ èŽ·å–è‡ª $LAST_TAG ä»¥æ¥çš„æäº¤è®°å½•"
          CHANGELOG=$(git log --pretty=format:"%h - %s" $LAST_TAG..HEAD)
        fi
        
        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="æ²¡æœ‰æ–°çš„å˜æ›´è®°å½•"
        fi
        
        # æ ¼å¼åŒ–å˜æ›´æ—¥å¿—
        CHANGELOG=$(echo "$CHANGELOG" | sed 's/ \([0-9a-f]\{7\} - \)/\n\1/g' | sed 's/\(fix\|add\|style\|update\)/\n\1/g')
        CHANGELOG=$(echo "$CHANGELOG" | jq -R -s '.')
        echo "CHANGELOG=$CHANGELOG" >> $GITHUB_ENV
        echo "âœ… å˜æ›´æ—¥å¿—ç”Ÿæˆå®Œæˆ"

    - name: åˆ›å»ºæž„å»ºåŒ…
      id: create-build-package
      if: env.new_version == 'true' && env.tag_exists == 'false'
      run: |
        echo "ðŸ“¦ å¼€å§‹åˆ›å»ºæž„å»ºåŒ…..."
        
        # åˆ›å»ºæž„å»ºç›®å½•
        mkdir -p build
        
        # åˆ›å»ºzipåŒ…ï¼ŒæŽ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        zip -r "newtab-${{ env.VERSION }}.zip" . \
          -x ".*" \
          -x "*/.*" \
          -x "build/*" \
          -x "README.md" \
          -x ".github/*" \
          -x "doc/*" \
          -x "examples/*" \
          -x "*.log" \
          -x "node_modules/*"
        
        # ç§»åŠ¨åˆ°æž„å»ºç›®å½•
        mv "newtab-${{ env.VERSION }}.zip" "build/"
        
        # è®¾ç½®æž„å»ºåŒ…è·¯å¾„
        BUILD_PATH="build/newtab-${{ env.VERSION }}.zip"
        echo "BUILD_PATH=$BUILD_PATH" >> $GITHUB_ENV
        
        # éªŒè¯æ–‡ä»¶
        if [ -f "$BUILD_PATH" ]; then
          FILE_SIZE=$(ls -lh "$BUILD_PATH" | awk '{print $5}')
          echo "âœ… æž„å»ºåŒ…åˆ›å»ºæˆåŠŸ: $BUILD_PATH (å¤§å°: $FILE_SIZE)"
        else
          echo "âŒ æž„å»ºåŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        fi

    - name: ä¸Šä¼ æž„å»ºåŒ…ä¸ºå·¥ä»¶
      id: upload-artifact
      if: env.new_version == 'true' && env.tag_exists == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: newtab-æž„å»ºåŒ…-${{ env.VERSION }}
        path: build/newtab-${{ env.VERSION }}.zip
        retention-days: 30

    - name: è¾“å‡ºæž„å»ºç»“æžœ
      id: output-summary
      run: |
        echo "## ðŸ” æž„å»ºç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| å½“å‰ç‰ˆæœ¬ | \`${{ env.VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| æœ€æ–°å‘å¸ƒç‰ˆæœ¬ | \`${{ env.LATEST_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| æ˜¯å¦æ–°ç‰ˆæœ¬ | ${{ env.new_version == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| æ ‡ç­¾æ˜¯å¦å­˜åœ¨ | ${{ env.tag_exists == 'true' && 'âš ï¸ å·²å­˜åœ¨' || 'âœ… ä¸å­˜åœ¨' }} |" >> $GITHUB_STEP_SUMMARY
        if [ "${{ env.new_version }}" == "true" ] && [ "${{ env.tag_exists }}" == "false" ]; then
          echo "| æž„å»ºåŒ… | âœ… å·²åˆ›å»º |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| æž„å»ºåŒ… | âŒ æœªåˆ›å»ºï¼ˆä¸æ»¡è¶³æ¡ä»¶ï¼‰ |" >> $GITHUB_STEP_SUMMARY
        fi
