name: å‘å¸ƒç®¡ç†
on:
  workflow_run:
    workflows: ["ç‰ˆæœ¬æ£€æŸ¥ä¸æ„å»º"]
    types:
      - completed
    branches:
      - main
  workflow_call:
    inputs:
      version:
        description: "ç‰ˆæœ¬å·"
        required: true
        type: string
      changelog:
        description: "å˜æ›´æ—¥å¿—å†…å®¹"
        required: true
        type: string
      build-path:
        description: "æ„å»ºåŒ…è·¯å¾„"
        required: true
        type: string
    outputs:
      release-id:
        description: "åˆ›å»ºçš„Release ID"
        value: ${{ jobs.release-management.outputs.release-id }}
      release-url:
        description: "Releaseé¡µé¢URL"
        value: ${{ jobs.release-management.outputs.release-url }}

jobs:
  release-management:
    name: å‘å¸ƒç®¡ç†
    runs-on: ubuntu-latest
    # ä¿®æ”¹æ¡ä»¶ï¼Œå…è®¸åœ¨ workflow_call æ—¶æ‰§è¡Œ
    if: github.event_name == 'workflow_call' || github.event_name == 'workflow_run'
    outputs:
      release-id: ${{ steps.create-release.outputs.id }}
      release-url: ${{ steps.create-release.outputs.html_url }}

    steps:
    - name: æ£€æŸ¥æƒé™å’Œ Token
      id: check-permissions
      run: |
        echo "ğŸ” æ£€æŸ¥ GitHub Token æƒé™..."
        
        # æ£€æŸ¥ Token æ˜¯å¦å­˜åœ¨
        if [ -z "${{ secrets.PAT }}" ]; then
          echo "âŒ PAT token æœªé…ç½®"
          exit 1
        fi
        
        # æ£€æŸ¥ä»“åº“è®¿é—®æƒé™
        REPO_INFO=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
          "https://api.github.com/repos/${{ github.repository }}")
        
        if echo "$REPO_INFO" | jq -e '.permissions.push' > /dev/null; then
          echo "âœ… Token æœ‰æ¨é€æƒé™"
        else
          echo "âŒ Token ç¼ºå°‘æ¨é€æƒé™"
          echo "Token info: $(echo "$REPO_INFO" | jq '.permissions // "æ— æƒé™ä¿¡æ¯"')"
          exit 1
        fi
        
        echo "âœ… æƒé™æ£€æŸ¥é€šè¿‡"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®è¾“å…¥å‚æ•°
      id: set-input-params
      run: |
        echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
        echo "âœ… ä½¿ç”¨å·¥ä½œæµè°ƒç”¨å‚æ•°ï¼Œç‰ˆæœ¬: ${{ inputs.version }}"

    - name: ç”Ÿæˆå‘å¸ƒå˜æ›´æ—¥å¿—
      id: generate-release-changelog
      run: |
        # ä½¿ç”¨ä¼ å…¥çš„å˜æ›´æ—¥å¿—ï¼Œç¡®ä¿æ­£ç¡®è§£æJSON
        CHANGELOG='${{ inputs.changelog }}'
        echo "CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$CHANGELOG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo "âœ… å‘å¸ƒå˜æ›´æ—¥å¿—å‡†å¤‡å®Œæˆ"

    - name: åˆ—å‡ºå¯ç”¨å·¥ä»¶
      id: list-artifacts
      run: |
        echo "ğŸ” åˆ—å‡ºå½“å‰å·¥ä½œæµè¿è¡Œçš„æ‰€æœ‰å·¥ä»¶..."
        
        # ä½¿ç”¨ GitHub API è·å–å·¥ä»¶åˆ—è¡¨
        ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts")
        
        echo "å·¥ä»¶åˆ—è¡¨:"
        echo "$ARTIFACTS" | jq -r '.artifacts[] | "- åç§°: \(.name), å¤§å°: \(.size_in_bytes) bytes, è¿‡æœŸ: \(.expired)"'
        
        # æŸ¥æ‰¾åŒ…å«ç‰ˆæœ¬å·çš„å·¥ä»¶
        ARTIFACT_NAME=$(echo "$ARTIFACTS" | jq -r --arg version "${{ inputs.version }}" \
          '.artifacts[] | select(.name | contains($version)) | .name' | head -1)
        
        if [ -n "$ARTIFACT_NAME" ]; then
          echo "æ‰¾åˆ°åŒ¹é…çš„å·¥ä»¶: $ARTIFACT_NAME"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°åŒ…å«ç‰ˆæœ¬å· ${{ inputs.version }} çš„å·¥ä»¶"
          echo "å°è¯•æŸ¥æ‰¾é€šç”¨æ„å»ºå·¥ä»¶..."
          
          # æŸ¥æ‰¾ä»»ä½•æ„å»ºç›¸å…³çš„å·¥ä»¶
          GENERIC_ARTIFACT=$(echo "$ARTIFACTS" | jq -r \
            '.artifacts[] | select(.name | test("newtab|build|æ„å»º")) | .name' | head -1)
          
          if [ -n "$GENERIC_ARTIFACT" ]; then
            echo "æ‰¾åˆ°é€šç”¨æ„å»ºå·¥ä»¶: $GENERIC_ARTIFACT"
            echo "ARTIFACT_NAME=$GENERIC_ARTIFACT" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•æ„å»ºå·¥ä»¶"
            exit 1
          fi
        fi

    - name: ä¸‹è½½æ„å»ºå·¥ä»¶
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: ./artifacts

    - name: éªŒè¯æ„å»ºåŒ…
      id: verify-build-package
      run: |
        echo "ğŸ“ å·¥ä»¶ç›®å½•å†…å®¹:"
        find ./artifacts -type f -ls
        
        # æŸ¥æ‰¾æ„å»ºåŒ…æ–‡ä»¶ï¼Œä½¿ç”¨æ›´çµæ´»çš„æœç´¢æ¨¡å¼
        BUILD_FILE=$(find ./artifacts -name "*.zip" | head -1)
        
        if [ -z "$BUILD_FILE" ]; then
          echo "âŒ åœ¨å·¥ä»¶ä¸­æœªæ‰¾åˆ°ZIPæ„å»ºåŒ…"
          
          # å°è¯•æŸ¥æ‰¾å…¶ä»–ç±»å‹çš„æ–‡ä»¶
          echo "ğŸ“ æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶:"
          find ./artifacts -type f
          
          # å¦‚æœæœ‰æ–‡ä»¶ä½†ä¸æ˜¯ZIPï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡ä»¶
          BUILD_FILE=$(find ./artifacts -type f | head -1)
          if [ -n "$BUILD_FILE" ]; then
            echo "âš ï¸ ä½¿ç”¨æ‰¾åˆ°çš„æ–‡ä»¶: $BUILD_FILE"
          else
            echo "âŒ å·¥ä»¶ç›®å½•ä¸ºç©º"
            exit 1
          fi
        fi
        
        FILE_SIZE=$(ls -lh "$BUILD_FILE" | awk '{print $5}')
        echo "âœ… æ„å»ºåŒ…éªŒè¯æˆåŠŸ: $BUILD_FILE (å¤§å°: $FILE_SIZE)"
        echo "BUILD_FILE=$BUILD_FILE" >> $GITHUB_ENV

    - name: åˆ›å»ºRelease
      id: create-release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "å‘å¸ƒ ${{ env.VERSION }}"
        body: ${{ fromJson(env.CHANGELOG) }}
        files: ${{ env.BUILD_FILE }}
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}

    - name: éªŒè¯å‘å¸ƒç»“æœ
      id: verify-release-result
      run: |
        if [ -n "${{ steps.create-release.outputs.id }}" ]; then
          echo "âœ… Releaseåˆ›å»ºæˆåŠŸ"
          echo "ğŸ”— Release ID: ${{ steps.create-release.outputs.id }}"
          echo "ğŸŒ Release URL: ${{ steps.create-release.outputs.html_url }}"
          
          echo "## ğŸ‰ å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | \`${{ env.VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release ID | \`${{ steps.create-release.outputs.id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release URL | [${{ steps.create-release.outputs.html_url }}](${{ steps.create-release.outputs.html_url }}) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Releaseåˆ›å»ºå¤±è´¥"
          exit 1
        fi
