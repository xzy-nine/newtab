name: å‘å¸ƒç®¡ç†
on:
  workflow_run:
    workflows: ["ç‰ˆæœ¬æ£€æŸ¥ä¸æ„å»º"]
    types:
      - completed
    branches:
      - main
  workflow_call:
    inputs:
      version:
        description: "ç‰ˆæœ¬å·"
        required: true
        type: string
      changelog:
        description: "å˜æ›´æ—¥å¿—å†…å®¹"
        required: true
        type: string
      build-path:
        description: "æ„å»ºåŒ…è·¯å¾„"
        required: true
        type: string
    outputs:
      release-id:
        description: "åˆ›å»ºçš„Release ID"
        value: ${{ jobs.release-management.outputs.release-id }}
      release-url:
        description: "Releaseé¡µé¢URL"
        value: ${{ jobs.release-management.outputs.release-url }}

jobs:
  release-management:
    name: å‘å¸ƒç®¡ç†
    runs-on: ubuntu-latest
    # ä¿®æ”¹æ¡ä»¶ï¼Œå…è®¸åœ¨ workflow_call æ—¶æ‰§è¡Œ
    if: github.event_name == 'workflow_call' || github.event_name == 'workflow_run'
    outputs:
      release-id: ${{ steps.create-release.outputs.id }}
      release-url: ${{ steps.create-release.outputs.html_url }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®è¾“å…¥å‚æ•°
      id: set-input-params
      run: |
        echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
        echo "âœ… ä½¿ç”¨å·¥ä½œæµè°ƒç”¨å‚æ•°ï¼Œç‰ˆæœ¬: ${{ inputs.version }}"

    - name: ç”Ÿæˆå‘å¸ƒå˜æ›´æ—¥å¿—
      id: generate-release-changelog
      run: |
        # ä½¿ç”¨ä¼ å…¥çš„å˜æ›´æ—¥å¿—ï¼Œç¡®ä¿æ­£ç¡®è§£æJSON
        CHANGELOG='${{ inputs.changelog }}'
        echo "CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$CHANGELOG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo "âœ… å‘å¸ƒå˜æ›´æ—¥å¿—å‡†å¤‡å®Œæˆ"

    - name: ä¸‹è½½æ„å»ºå·¥ä»¶
      uses: actions/download-artifact@v4
      with:
        name: newtab-æ„å»ºåŒ…-${{ inputs.version }}
        path: ./artifacts

    - name: éªŒè¯æ„å»ºåŒ…
      id: verify-build-package
      run: |
        # æŸ¥æ‰¾æ„å»ºåŒ…æ–‡ä»¶ï¼Œä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶åæ¨¡å¼
        BUILD_FILE=$(find ./artifacts -name "newtab-${{ inputs.version }}.zip" -o -name "*.zip" | head -1)
        
        if [ -z "$BUILD_FILE" ]; then
          echo "âŒ åœ¨å·¥ä»¶ä¸­æœªæ‰¾åˆ°æ„å»ºåŒ…"
          echo "ğŸ“ å·¥ä»¶ç›®å½•å†…å®¹:"
          find ./artifacts -type f -ls
          exit 1
        fi
        
        FILE_SIZE=$(ls -lh "$BUILD_FILE" | awk '{print $5}')
        echo "âœ… æ„å»ºåŒ…éªŒè¯æˆåŠŸ: $BUILD_FILE (å¤§å°: $FILE_SIZE)"
        echo "BUILD_FILE=$BUILD_FILE" >> $GITHUB_ENV

    - name: åˆ›å»ºRelease
      id: create-release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "å‘å¸ƒ ${{ env.VERSION }}"
        body: ${{ fromJson(env.CHANGELOG) }}
        files: ${{ env.BUILD_FILE }}
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}

    - name: éªŒè¯å‘å¸ƒç»“æœ
      id: verify-release-result
      run: |
        if [ -n "${{ steps.create-release.outputs.id }}" ]; then
          echo "âœ… Releaseåˆ›å»ºæˆåŠŸ"
          echo "ğŸ”— Release ID: ${{ steps.create-release.outputs.id }}"
          echo "ğŸŒ Release URL: ${{ steps.create-release.outputs.html_url }}"
          
          echo "## ğŸ‰ å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | \`${{ env.VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release ID | \`${{ steps.create-release.outputs.id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release URL | [${{ steps.create-release.outputs.html_url }}](${{ steps.create-release.outputs.html_url }}) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Releaseåˆ›å»ºå¤±è´¥"
          exit 1
        fi
