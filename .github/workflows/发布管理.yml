name: å‘å¸ƒç®¡ç†
on:
  workflow_run:
    workflows: ["ç‰ˆæœ¬æ£€æŸ¥ä¸æ„å»º"]
    types:
      - completed
    branches:
      - main
  workflow_call:
    inputs:
      ç‰ˆæœ¬å·:
        description: "ç‰ˆæœ¬å·"
        required: true
        type: string
      å˜æ›´æ—¥å¿—:
        description: "å˜æ›´æ—¥å¿—å†…å®¹"
        required: true
        type: string
      æ„å»ºåŒ…è·¯å¾„:
        description: "æ„å»ºåŒ…è·¯å¾„"
        required: true
        type: string
    outputs:
      å‘å¸ƒID:
        description: "åˆ›å»ºçš„Release ID"
        value: ${{ jobs.å‘å¸ƒç®¡ç†.outputs.å‘å¸ƒID }}
      å‘å¸ƒURL:
        description: "Releaseé¡µé¢URL"
        value: ${{ jobs.å‘å¸ƒç®¡ç†.outputs.å‘å¸ƒURL }}

jobs:
  å‘å¸ƒç®¡ç†:
    name: å‘å¸ƒç®¡ç†
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_call'
    outputs:
      å‘å¸ƒID: ${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.id }}
      å‘å¸ƒURL: ${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.html_url }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è·å–æ„å»ºå·¥ä»¶ä¿¡æ¯
      if: github.event_name == 'workflow_run'
      id: è·å–å·¥ä»¶ä¿¡æ¯
      run: |
        # ä»è§¦å‘çš„å·¥ä½œæµè·å–ç‰ˆæœ¬ä¿¡æ¯
        echo "è·å–æ„å»ºå·¥ä½œæµçš„è¾“å‡ºä¿¡æ¯..."
        
        # é€šè¿‡APIè·å–å·¥ä½œæµè¿è¡Œçš„å·¥ä»¶
        ARTIFACTS_URL="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts"
        ARTIFACTS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$ARTIFACTS_URL")
        
        # æŸ¥æ‰¾æ„å»ºåŒ…å·¥ä»¶
        ARTIFACT_NAME=$(echo "$ARTIFACTS_RESPONSE" | jq -r '.artifacts[] | select(.name | contains("newtab-æ„å»ºåŒ…")) | .name' | head -1)
        if [ -z "$ARTIFACT_NAME" ]; then
          echo "âŒ æœªæ‰¾åˆ°æ„å»ºåŒ…å·¥ä»¶"
          exit 1
        fi
        
        # ä»å·¥ä»¶åç§°æå–ç‰ˆæœ¬å·
        VERSION=$(echo "$ARTIFACT_NAME" | sed 's/newtab-æ„å»ºåŒ…-//')
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
        echo "âœ… æ‰¾åˆ°æ„å»ºåŒ…å·¥ä»¶: $ARTIFACT_NAMEï¼Œç‰ˆæœ¬: $VERSION"

    - name: è®¾ç½®è¾“å…¥å‚æ•°
      if: github.event_name == 'workflow_call'
      run: |
        echo "VERSION=${{ inputs.ç‰ˆæœ¬å· }}" >> $GITHUB_ENV
        echo "âœ… ä½¿ç”¨å·¥ä½œæµè°ƒç”¨å‚æ•°ï¼Œç‰ˆæœ¬: ${{ inputs.ç‰ˆæœ¬å· }}"

    - name: ä¸‹è½½æ„å»ºåŒ…å·¥ä»¶
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: build/
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: ç”Ÿæˆå‘å¸ƒå˜æ›´æ—¥å¿—
      id: ç”Ÿæˆå‘å¸ƒå˜æ›´æ—¥å¿—
      run: |
        if [ "${{ github.event_name }}" == "workflow_call" ]; then
          # ä½¿ç”¨ä¼ å…¥çš„å˜æ›´æ—¥å¿—
          CHANGELOG='${{ inputs.å˜æ›´æ—¥å¿— }}'
        else
          # é‡æ–°ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "ğŸ“ é‡æ–°ç”Ÿæˆå˜æ›´æ—¥å¿—..."
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"%h - %s")
          else
            CHANGELOG=$(git log --pretty=format:"%h - %s" $LAST_TAG..HEAD)
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="æ²¡æœ‰æ–°çš„å˜æ›´è®°å½•"
          fi
          
          # æ ¼å¼åŒ–å˜æ›´æ—¥å¿—
          CHANGELOG=$(echo "$CHANGELOG" | sed 's/ \([0-9a-f]\{7\} - \)/\n\1/g' | sed 's/\(fix\|add\|style\|update\)/\n\1/g')
          CHANGELOG=$(echo "$CHANGELOG" | jq -R -s '.')
        fi
        
        echo "CHANGELOG=$CHANGELOG" >> $GITHUB_ENV
        echo "âœ… å‘å¸ƒå˜æ›´æ—¥å¿—å‡†å¤‡å®Œæˆ"

    - name: éªŒè¯æ„å»ºåŒ…
      run: |
        if [ "${{ github.event_name }}" == "workflow_call" ]; then
          BUILD_FILE="${{ inputs.æ„å»ºåŒ…è·¯å¾„ }}"
        else
          BUILD_FILE="build/newtab-${{ env.VERSION }}.zip"
        fi
        
        if [ -f "$BUILD_FILE" ]; then
          FILE_SIZE=$(ls -lh "$BUILD_FILE" | awk '{print $5}')
          echo "âœ… æ„å»ºåŒ…éªŒè¯æˆåŠŸ: $BUILD_FILE (å¤§å°: $FILE_SIZE)"
          echo "BUILD_FILE=$BUILD_FILE" >> $GITHUB_ENV
        else
          echo "âŒ æ„å»ºåŒ…ä¸å­˜åœ¨: $BUILD_FILE"
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          find . -name "*.zip" -type f
          exit 1
        fi

    - name: åˆ›å»ºRelease
      id: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "å‘å¸ƒ ${{ env.VERSION }}"
        body: ${{ fromJson(env.CHANGELOG) }}
        files: ${{ env.BUILD_FILE }}
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}

    - name: éªŒè¯å‘å¸ƒç»“æœ
      run: |
        if [ -n "${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.id }}" ]; then
          echo "âœ… Releaseåˆ›å»ºæˆåŠŸ"
          echo "ğŸ”— Release ID: ${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.id }}"
          echo "ğŸŒ Release URL: ${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.html_url }}"
          
          # æ·»åŠ åˆ°ä½œä¸šæ‘˜è¦
          echo "## ğŸ‰ å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | \`${{ env.VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release ID | \`${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release URL | [${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.html_url }}](${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.html_url }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºåŒ… | \`${{ env.BUILD_FILE }}\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Releaseåˆ›å»ºå¤±è´¥"
          exit 1
        fi

    - name: è§¦å‘AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
      if: success()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: 'AIå˜æ›´æ—¥å¿—ç”Ÿæˆ.yml',
              ref: 'main',
              inputs: {
                'ç‰ˆæœ¬å·': '${{ env.VERSION }}',
                'å‘å¸ƒID': '${{ steps.åˆ›å»ºå‘å¸ƒ.outputs.id }}'
              }
            });
            console.log('âœ… å·²è§¦å‘AIå˜æ›´æ—¥å¿—ç”Ÿæˆå·¥ä½œæµ');
          } catch (error) {
            console.log('âš ï¸ è§¦å‘AIå˜æ›´æ—¥å¿—ç”Ÿæˆå·¥ä½œæµå¤±è´¥:', error.message);
          }
