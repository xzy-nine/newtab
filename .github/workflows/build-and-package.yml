name: Build and Package  # æ„å»ºå’Œæ‰“åŒ…å·¥ä½œæµ

on:
  push:
    branches:
      - main  # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build:
    runs-on: ubuntu-latest  # åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu è¿è¡Œç¯å¢ƒä¸­æ‰§è¡Œ
    # æ·»åŠ æƒé™é…ç½®:
    permissions:
      contents: write
      packages: write
      issues: write  # æ·»åŠ è¿™ä¸€è¡Œ,

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      # æ£€å‡ºä»“åº“ä»£ç åˆ°è¿è¡Œç¯å¢ƒä¸­ï¼Œç¡®ä¿å·¥ä½œæµå¯ä»¥è®¿é—®æœ€æ–°çš„ä»£ç 

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'
      # é…ç½® Node.js è¿è¡Œç¯å¢ƒï¼Œé€‰æ‹© v14 ç‰ˆæœ¬ä»¥ç¡®ä¿é¡¹ç›®ä¾èµ–å…¼å®¹æ€§

    - name: Install dependencies
      run: npm install
      # å®‰è£…é¡¹ç›®æ‰€éœ€çš„ npm ä¾èµ–åŒ…ï¼Œç¡®ä¿æ„å»ºç¯å¢ƒå®Œæ•´

    - name: Get version from manifest.json
      id: get_version
      run: |
        VERSION=$(jq -r '.version' manifest.json)
        # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼æ˜¯å¦ç¬¦åˆ x.y.z è§„èŒƒ
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Invalid version format in manifest.json"
          exit 1
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
      # ä»é¡¹ç›®çš„ manifest.json ä¸­æå–ç‰ˆæœ¬å·å¹¶å­˜å‚¨ä¸ºç¯å¢ƒå˜é‡ï¼Œç”¨äºåç»­çš„ç‰ˆæœ¬æ§åˆ¶

    - name: Get latest release version
      id: get_latest_release
      run: |
        # å¤„ç†é¦–æ¬¡å‘å¸ƒçš„æƒ…å†µ
        LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name // "0.0.0"')
        if [[ ! $LATEST_RELEASE =~ ^[0-9]+\.[0-9]+\.[0-9]+(_DEBUG)?$ ]]; then
          LATEST_RELEASE="0.0.0"
        fi
        echo "LATEST_RELEASE=$LATEST_RELEASE" >> $GITHUB_ENV
      # é€šè¿‡ GitHub API è·å–ä»“åº“æœ€æ–°å‘å¸ƒç‰ˆæœ¬å·ï¼Œç”¨äºç‰ˆæœ¬æ¯”è¾ƒå’Œå‘å¸ƒæ§åˆ¶
    - name: Compare ver,ions
      id: compare_versions
      run: |
        # æ·»åŠ ç‰ˆæœ¬å·æ ¼å¼éªŒè¯å‡½æ•°
        validate_version() {,
          if [[ ! $1 =~ ^[0-9]+\.[0-9]+\.[0-9]+(_DEBUG)?$ ]]; then
            echo "Error: Invali. version format: $1"
            return 1
          fi
          return 0
        }
        
        # éªŒè¯ä¸¤ä¸ªç‰ˆæœ¬å·
        validate_version "${{ env.VERSION }}" || exit 1
        validate_version "${{ env.LATEST_RELEASE }}" || exit 1
        
        # ç¡®ä¿ç‰ˆæœ¬å·å­˜åœ¨
        if [ -z "${{ env.VERSION }}" ] || [ -z "${{ env.LATEST_RELEASE }}" ]; then
          echo "Error: Missing version information"
          exit 1
        fi
        
        # æå–ä¸å¸¦ _DEBUG çš„ç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒ
        CURRENT_VER=$(echo ${{ env.VERSION }} | sed 's/_DEBUG$//')
        LATEST_VER=$(echo ${{ env.LATEST_RELEASE }} | sed 's/_DEBUG$//')
        
        # ç¡®ä¿ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡®
        if [[ ! $CURRENT_VER =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] || [[ ! $LATEST_VER =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Invalid version format"
          exit 1
        fi
        
        # è¯­ä¹‰åŒ–ç‰ˆæœ¬å·æ¯”è¾ƒ
        if [ $(printf '%s\n' "$LATEST_VER" "$CURRENT_VER" | sort -V | tail -n1) = "$CURRENT_VER" ]; then
          echo "NEW_VERSION=true" >> $GITHUB_ENV
        else
          echo "NEW_VERSION=false" >> $GITHUB_ENV
        fi

    - name: Set release name
      id: set_release_name
      run: |
        if [ "${{ env.NEW_VERSION }}" = "false" ] && [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "RELEASE_NAME=${VERSION}_DEBUG" >> $GITHUB_ENV
          echo "TAG_NAME=${VERSION}_DEBUG" >> $GITHUB_ENV
        else
          echo "RELEASE_NAME=$VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=$VERSION" >> $GITHUB_ENV
        fi
      # è®¾ç½®å‘å¸ƒæ ‡ç­¾å’Œåç§°
      # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”ç‰ˆæœ¬å·æœªå˜åŒ–ï¼Œæ·»åŠ  _DEBUG åç¼€ç”¨äºè°ƒè¯•ç‰ˆæœ¬
      # å¦åˆ™ä½¿ç”¨ manifest.json ä¸­çš„åŸå§‹ç‰ˆæœ¬å·

    - name: Check recent notifications and gather changes
      if: ${{ env.NEW_VERSION == 'false' && github.event_name == 'push' }}
      uses: actions/github-script@v6
      id: check_notifications
      with:
        script: |
          const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
          
          // æœç´¢æœ€è¿‘24å°æ—¶å†…çš„é€šçŸ¥issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            labels: 'ç‰ˆæœ¬æœªæ›´æ–°',
            since: twentyFourHoursAgo.toISOString()
          });
          
          // è·å–æœ€è¿‘ä¸€æ¬¡é€šçŸ¥çš„æ—¶é—´
          let lastNotificationTime = twentyFourHoursAgo;
          if (issues.data.length > 0) {
            lastNotificationTime = new Date(issues.data[0].created_at);
          }
          
          // è·å–ä»ä¸Šæ¬¡é€šçŸ¥åˆ°ç°åœ¨çš„æ‰€æœ‰æäº¤
          const commits = await github.rest.repos.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            since: lastNotificationTime.toISOString(),
            until: new Date().toISOString()
          });
          
          // æ•´ç†æ‰€æœ‰å˜æ›´ä¿¡æ¯
          const changes = commits.data.map(commit => ({
            message: commit.commit.message,
            author: commit.commit.author.name,
            timestamp: commit.commit.author.date,
            url: commit.html_url,
            // è·å–ä¿®æ”¹çš„æ–‡ä»¶
            files: commit.files ? commit.files.map(f => f.filename).join('\n') : ''
          }));
          
          return {
            hasRecentNotification: issues.data.length > 0,
            changes: changes
          };

    - name: Create or update notification issue
      if: ${{ github.event_name == 'push' }}
      uses: actions/github-script@v6
      with:
        script: |
          const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
          
          // æœç´¢ç°æœ‰çš„è¿½è¸ª issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['é€šçŸ¥']
          });
          
          const TRACKING_ISSUE_TITLE = process.env.NEW_VERSION === 'true' 
            ? 'ğŸ‰ ç‰ˆæœ¬æ›´æ–°è¿½è¸ª' 
            : 'ğŸ“ ä»£ç æ›´æ–°è¿½è¸ª';
          
          // æŸ¥æ‰¾å¯¹åº”ç±»å‹çš„è¿½è¸ª issue
          const existingIssue = issues.data.find(issue => issue.title === TRACKING_ISSUE_TITLE);
          
          // è·å–å½“å‰æäº¤çš„ä¿¡æ¯
          const commit = context.payload.commits[0];
          const updateInfo = [
            '### æ›´æ–°è®°å½• (' + new Date().toISOString() + ')',
            '',
            '#### æäº¤ä¿¡æ¯',
            `\`\`\``,
            commit.message,
            `\`\`\``,
            '',
            '#### æ›´æ”¹çš„æ–‡ä»¶',
            '```',
            (commit.modified || []).join('\n'),
            '```',
            '',
            '#### æäº¤è¯¦æƒ…',
            `- æäº¤è€…ï¼š${commit.author.name}`,
            `- æäº¤æ—¶é—´ï¼š${commit.timestamp}`,
            `- æäº¤ SHAï¼š${commit.id}`,
            `- æŸ¥çœ‹å˜æ›´ï¼š${commit.url}`,
            '',
            '---',
            ''
          ].join('\n');

          if (existingIssue) {
            const lastUpdateTime = new Date(existingIssue.updated_at);
            if (lastUpdateTime < twentyFourHoursAgo) {
              // å¦‚æœè¶…è¿‡24å°æ—¶ï¼Œæ·»åŠ æ–°è¯„è®º
              const commentBody = [
                `## ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })} çš„æ›´æ–°`,
                '',
                updateInfo,
                '',
                process.env.NEW_VERSION === 'true' 
                  ? '> ğŸ‰ è¿™æ˜¯ä¸€ä¸ªæ–°ç‰ˆæœ¬æ›´æ–°é€šçŸ¥ã€‚'
                  : '> â„¹ï¸ è¿™æ˜¯ä¸€ä¸ªä»£ç æ›´æ–°é€šçŸ¥ï¼Œä½†ç‰ˆæœ¬å·æœªæ›´æ–°ã€‚'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: commentBody
              });
            }
            // å¦‚æœåœ¨24å°æ—¶å†…ï¼Œä¸åšä»»ä½•æ“ä½œ
          } else {
            // åˆ›å»ºæ–°çš„è¿½è¸ª issue
            const initialBody = [
              '# ' + (process.env.NEW_VERSION === 'true' ? 'ç‰ˆæœ¬æ›´æ–°è¿½è¸ª' : 'ä»£ç æ›´æ–°è¿½è¸ª'),
              '',
              'æ­¤ Issue ç”¨äºè¿½è¸ªä»£ç æ›´æ–°ï¼Œå°†åœ¨24å°æ—¶åå¼€å§‹è®°å½•æ–°çš„æ›´æ–°ã€‚',
              '',
              '## å½“å‰ç‰ˆæœ¬ä¿¡æ¯',
              `- å½“å‰ç‰ˆæœ¬å·ï¼š\`${process.env.VERSION}\``,
              `- ä¸Šæ¬¡ç‰ˆæœ¬å·ï¼š\`${process.env.LATEST_RELEASE}\``,
              '',
              '## é¦–æ¬¡æ›´æ–°è®°å½•',
              '',
              updateInfo,
              '',
              process.env.NEW_VERSION === 'true'
                ? '> ğŸ‰ è¿™æ˜¯ä¸€ä¸ªç‰ˆæœ¬æ›´æ–°è¿½è¸ª issueã€‚'
                : '> â„¹ï¸ è¿™æ˜¯ä¸€ä¸ªä»£ç æ›´æ–°è¿½è¸ª issueã€‚å¦‚éœ€å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œè¯·æ›´æ–° manifest.json ä¸­çš„ç‰ˆæœ¬å·ã€‚'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: TRACKING_ISSUE_TITLE,
              body: initialBody,
              labels: ['é€šçŸ¥', process.env.NEW_VERSION === 'true' ? 'ç‰ˆæœ¬æ›´æ–°' : 'ä»£ç æ›´æ–°']
            });
          }

    - name: Check and update version notification issue
      if: ${{ env.NEW_VERSION == 'false' && github.event_name == 'push' }}
      uses: actions/github-script@v6
      with:
        script: |
          try {
            // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç‰ˆæœ¬æ›´æ–°é€šçŸ¥ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['ç‰ˆæœ¬æ›´æ–°é€šçŸ¥']
            });
            
            // æŸ¥æ‰¾ç‰¹å®šæ ‡é¢˜çš„issue
            const notificationIssue = issues.data.find(issue => 
              issue.title === 'ğŸ“ ç‰ˆæœ¬æ›´æ–°é€šçŸ¥è¿½è¸ª'
            );
            
            // åˆ›å»ºæ›´æ–°å†…å®¹
            const modified = context.payload.commits[0].modified || [];
            const updateInfo = [
              '### æ›´æ–°è®°å½• (' + new Date().toISOString() + ')',
              '',
              '#### æäº¤ä¿¡æ¯',
              context.payload.commits[0].message,
              '',
              '#### æ›´æ”¹çš„æ–‡ä»¶',
              '```',
              modified.join('\n'),
              '```',
              '',
              '#### æäº¤è¯¦æƒ…',
              '- æäº¤è€…ï¼š' + context.payload.commits[0].author.name,
              '- æäº¤æ—¶é—´ï¼š' + context.payload.commits[0].timestamp,
              '- æŸ¥çœ‹å˜æ›´ï¼š' + context.payload.commits[0].url,
              '',
              '---',
              ''
            ].join('\n');
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°é€šçŸ¥ issueï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
            if (!notificationIssue) {
              const initialBody = [
                '# ç‰ˆæœ¬æ›´æ–°é€šçŸ¥è¿½è¸ª',
                '',
                'æ­¤ Issue ç”¨äºè¿½è¸ªæ‰€æœ‰æœªæ›´æ–°ç‰ˆæœ¬å·çš„ä»£ç å˜æ›´ã€‚',
                '',
                '## å½“å‰ç‰ˆæœ¬ä¿¡æ¯',
                '- å½“å‰ç‰ˆæœ¬å·ï¼š`' + process.env.VERSION + '`',
                '- ä¸Šæ¬¡ç‰ˆæœ¬å·ï¼š`' + process.env.LATEST_RELEASE + '`',
                '',
                '> **æç¤ºï¼š** å¦‚éœ€å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œè¯·æ›´æ–° manifest.json ä¸­çš„ç‰ˆæœ¬å·ã€‚',
                '',
                '## å˜æ›´è®°å½•',
                '',
                updateInfo
              ].join('\n');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“ ç‰ˆæœ¬æ›´æ–°é€šçŸ¥è¿½è¸ª',
                body: initialBody,
                labels: ['ç‰ˆæœ¬æ›´æ–°é€šçŸ¥']
              });
            } else {
              // æ›´æ–°ç°æœ‰ issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: notificationIssue.number,
                body: notificationIssue.body + '\n' + updateInfo
              });
            }
          } catch (error) {
            console.error('Error updating notification issue:', error);
            return;
          }

    - name: Set repository name
      run: |
        REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
        echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

    - name: Create and move zip package
      # ä¿®æ”¹æ¡ä»¶ï¼šåªåœ¨æ˜¯æ–°ç‰ˆæœ¬æˆ–æ‰‹åŠ¨è§¦å‘ä¸”ä¸ºè°ƒè¯•ç‰ˆæœ¬æ—¶æ‰“åŒ…
      if: ${{ env.NEW_VERSION == 'true' || (github.event_name == 'workflow_dispatch' && env.NEW_VERSION == 'false') }}
      run: |
        set -e  # æ·»åŠ è¿™è¡Œä½¿è„šæœ¬åœ¨é‡åˆ°é”™è¯¯æ—¶ç«‹å³é€€å‡º
        
        # ä½¿ç”¨ç¯å¢ƒå˜é‡ REPO_NAME
        mkdir -p build
        
        zip -r "${{ env.REPO_NAME }}-${{ env.RELEASE_NAME }}.zip" . -x "README.md" -x "build/*" -x ".github/*" -x ".git/*"
        
        mv "${{ env.REPO_NAME }}-${{ env.RELEASE_NAME }}.zip" build/
        
        if [ ! -f "build/${{ env.REPO_NAME }}-${{ env.RELEASE_NAME }}.zip" ]; then
          echo "Error: Failed to create zip package"
          exit 1
        fi
        
        # å°†buildç›®å½•æ·»åŠ åˆ°git
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git add build/
        git commit -m "chore: update build artifacts for version ${{ env.RELEASE_NAME }}"
        git push
      # æ‰“åŒ…é¡¹ç›®æ–‡ä»¶
      # 1. åˆ›å»º build ç›®å½•
      # 2. å°†é¡¹ç›®æ–‡ä»¶æ‰“åŒ…æˆ zipï¼Œæ’é™¤æ–‡æ¡£å’Œæ„å»ºç›¸å…³æ–‡ä»¶
      # 3. ç§»åŠ¨å‹ç¼©åŒ…åˆ° build ç›®å½•
      # ä»…åœ¨æ‰‹åŠ¨è§¦å‘æˆ–ç‰ˆæœ¬å·æ›´æ–°æ—¶æ‰§è¡Œ

    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "refs/tags/${{ env.TAG_NAME }}" >/dev/null 2>&1; then
          echo "TAG_EXISTS=true" >> $GITHUB_ENV
        else
          echo "TAG_EXISTS=false" >> $GITHUB_ENV
        fi

    - name: Delete existing tag if exists
      if: ${{ env.TAG_EXISTS == 'true' }}
      run: |
        git tag -d ${{ env.TAG_NAME }} || true
        git push --delete origin ${{ env.TAG_NAME }} || true

    - name: Create Release
      id: create_release
      if: ${{ (env.NEW_VERSION == 'true' || (github.event_name == 'workflow_dispatch' && env.NEW_VERSION == 'false')) && env.TAG_EXISTS == 'false' }}
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        release_name: ${{ env.RELEASE_NAME }}
        draft: false
        prerelease: ${{ env.NEW_VERSION != 'true' }}
        body: |
          ${{ env.NEW_VERSION == 'true' && format('
          # å‘å¸ƒè¯´æ˜
          
          æ­¤ç‰ˆæœ¬å°†åœ¨[Microsoft Edge æ‰©å±•å•†åº—](https://microsoftedge.microsoft.com/addons/detail/xzy%E6%96%B0%E6%A0%87%E7%AD%BE%E9%A1%B5%E6%8B%93%E5%B1%95/lpdhbhkcbnhldcpcbocplhgeooabhbme)å‘å¸ƒã€‚

          ### æ›´æ–°å†…å®¹

          - ç‰ˆæœ¬å·ï¼š{0}
          - å‘å¸ƒæ—¶é—´ï¼š{1}
          
          ---
          ', env.VERSION, github.event.head_commit.timestamp) || format('
          # è°ƒè¯•ç‰ˆæœ¬
          
          è¿™æ˜¯ä¸€ä¸ªè°ƒè¯•ç‰ˆæœ¬ï¼ˆ{0}ï¼‰ï¼Œä»…ç”¨äºæµ‹è¯•ã€‚
          ', env.RELEASE_NAME) }}
      # åˆ›å»º GitHub Release
      # 1. ä½¿ç”¨é…ç½®çš„ç‰ˆæœ¬æ ‡ç­¾å’Œåç§°
      # 2. è®¾ç½®ä¸ºé¢„å‘å¸ƒçŠ¶æ€ï¼Œå…è®¸åç»­æ›´æ–°
      # 3. è‡ªåŠ¨ä½¿ç”¨ GitHub Token è¿›è¡Œè®¤è¯
      # ä»…åœ¨æ‰‹åŠ¨è§¦å‘æˆ–ç‰ˆæœ¬å·æ›´æ–°æ—¶æ‰§è¡Œ

    - name: Upload Release Asset
      if: ${{ env.NEW_VERSION == 'true' || (github.event_name == 'workflow_dispatch' && env.NEW_VERSION == 'false') }}
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/${{ env.REPO_NAME }}-${{ env.RELEASE_NAME }}.zip
        asset_name: ${{ env.REPO_NAME }}-${{ env.RELEASE_NAME }}.zip
        asset_content_type: application/zip
      continue-on-error: true
      # ä¸Šä¼ å‘å¸ƒèµ„äº§
      # 1. å°†æ„å»ºçš„ zip åŒ…ä¸Šä¼ åˆ°åˆšåˆ›å»ºçš„ Release
      # 2. ä½¿ç”¨å‰ä¸€æ­¥éª¤è¿”å›çš„ä¸Šä¼  URL
      # 3. è®¾ç½®æ­£ç¡®çš„å†…å®¹ç±»å‹
      # ä»…åœ¨æ‰‹åŠ¨è§¦å‘æˆ–ç‰ˆæœ¬å·æ›´æ–°æ—¶æ‰§è¡Œ