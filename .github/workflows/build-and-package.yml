name: auto Build and Package  # è‡ªåŠ¨æ„å»ºå’Œæ‰“åŒ…å·¥ä½œæµ

on:
  push:
    branches:
      - main

jobs:
  build:
    timeout-minutes: 15  # æ·»åŠ è¶…æ—¶è®¾ç½®
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    permissions:
      contents: write
      packages: write
      actions: read

    steps:
      # B: æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: Cache Dependencies
        uses: actions/cache@v3
        id: cache
        with:
          path: |
            build
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # C: è®¾ç½® Node.js ç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'  # æ·»åŠ ç¼“å­˜æ”¯æŒ

      # C: å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          if [ ! -f "package.json" ]; then
            echo "Error: package.json not found"
            exit 1
          fi
          npm ci  # ä½¿ç”¨ ci æ›¿ä»£ install ä»¥ç¡®ä¿ä¸€è‡´æ€§

      # D: ä» manifest.json è·å–ç‰ˆæœ¬ä¿¡æ¯
      - name: Get version from manifest.json
        id: get_version
        run: |
          if [ ! -f "manifest.json" ]; then
            echo "Error: manifest.json not found"
            exit 1
          fi
          VERSION=$(jq -r '.version' manifest.json)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format in manifest.json"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # E: è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬
      - name: Get Latest Release Version
        id: get_latest_release
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/latest)
          HTTP_CODE=$(tail -n1 <<< "$RESPONSE")
          CONTENT=$(sed '$ d' <<< "$RESPONSE")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Warning: Failed to get latest release, using 0.0.0"
            echo "latest_release=0.0.0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST_RELEASE=$(echo "$CONTENT" | jq -r '.tag_name // "0.0.0"')
          echo "latest_release=$LATEST_RELEASE" >> $GITHUB_OUTPUT

      # F: æ¯”è¾ƒç‰ˆæœ¬
      - name: Compare Versions
        id: compare_versions
        run: |
          # å®‰è£… semver å·¥å…·
          npm install -g semver
          
          CURRENT_VER="${{ steps.get_version.outputs.version }}"
          LATEST_VER="${{ steps.get_latest_release.outputs.latest_release }}"
          
          # å½“å‰é€»è¾‘æœ‰é‡å¤åˆ¤æ–­ï¼Œå¯ä»¥ç®€åŒ–ä¸º:
          if ! semver "$CURRENT_VER" >/dev/null 2>&1 || ! semver "$LATEST_VER" >/dev/null 2>&1; then
            echo "Error: Invalid version format"
            exit 1
          fi
          
          if semver -r "> $LATEST_VER" "$CURRENT_VER" >/dev/null; then
            echo "Found new version, continuing workflow..."
            echo "new_version=true" >> $GITHUB_OUTPUT
          else
            echo "No new version detected, stopping workflow..."
            echo "new_version=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ›´ä¸¥æ ¼çš„ç‰ˆæœ¬æ ¼å¼éªŒè¯
          if [[ ! "$CURRENT_VER" =~ ^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)$ ]]; then
            echo "Error: Invalid current version format: $CURRENT_VER"
            exit 1
          fi

      # G: ç”Ÿæˆå˜æ›´æ—¥å¿—
      - name: Generate Changelog
        if: steps.compare_versions.outputs.new_version == 'true'
        id: changelog
        run: |
          LATEST_TAG="${{ steps.get_latest_release.outputs.latest_release }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Latest release version is empty"
            exit 1
          fi
          
          if ! git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            echo "Warning: Tag $LATEST_TAG not found, using first commit"
            LATEST_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          if ! CHANGELOG=$(git log "$LATEST_TAG"..HEAD --merges --pretty=format:"[#%h]($REPO_URL/commit/%H) - %s"); then
            echo "Warning: Failed to generate changelog"
            CHANGELOG="No changes"
          fi
          
          # å¦‚æœæ—¥å¿—ä¸ºç©º,æ˜¾ç¤º"No changes"è€Œä¸æ˜¯ä½¿ç”¨æ‰€æœ‰æäº¤
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No changes"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # H: éªŒè¯å¿…è¦æ–‡ä»¶
      - name: Verify Required Files
        if: steps.compare_versions.outputs.new_version == 'true'
        run: |
          required_files=("manifest.json" "package.json")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Required file $file not found"
              exit 1
            fi
          done

      # I: åˆ›å»ºå¹¶ç§»åŠ¨ zip åŒ…
      - name: Create and Move Zip Package
        if: steps.compare_versions.outputs.new_version == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          # æ¸…ç†å¹¶åˆ›å»ºæ„å»ºç›®å½•
          rm -rf build
          mkdir -p build
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
          TMP_DIR=$(mktemp -d)
          cp -r . "$TMP_DIR/"
          cd "$TMP_DIR"
          
          # ç§»é™¤ä¸éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•
          rm -rf \
            README.md \
            build \
            .github \
            .git \
            node_modules \
            *.log \
            .gitignore \
            package-lock.json
          
          # åˆ›å»º zip åŒ…
          zip -r "$REPO_NAME-$VERSION.zip" .
          mv "$REPO_NAME-$VERSION.zip" ../build/
          cd ..
          rm -rf "$TMP_DIR"
          
          # éªŒè¯ zip åŒ…
          if [ ! -f "build/$REPO_NAME-$VERSION.zip" ]; then
            echo "Error: Failed to create zip package"
            exit 1
          fi

      # J: åˆ›å»º Release
      - name: Set Release Time
        run: echo "RELEASE_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

      - name: Create Release
        if: steps.compare_versions.outputs.new_version == 'true'
        id: create_release  # æ·»åŠ è¿™è¡Œ
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          body: |
            Release ${{ steps.get_version.outputs.version }}
            
            Changes in this release:
            ${{ steps.changelog.outputs.changelog }}
            
            è‡ªåŠ¨å‘å¸ƒæ—¶é—´: ${{ env.RELEASE_TIME }}
          draft: false
          prerelease: false

      # K: ä¸Šä¼  Release èµ„æº
      - name: Upload Release Asset
        if: steps.compare_versions.outputs.new_version == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build/${{ github.event.repository.name }}-${{ steps.get_version.outputs.version }}.zip
          asset_name: ${{ github.event.repository.name }}-${{ steps.get_version.outputs.version }}.zip
          asset_content_type: application/zip

      # L: é”™è¯¯é€šçŸ¥
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const { repo, owner } = context.repo;
            const run_id = context.runId;
            const run_url = `https://github.com/${owner}/${repo}/actions/runs/${run_id}`;
            const workflow_name = context.workflow;
            const run_number = context.runNumber;
            const message = `âš ï¸ Workflow failed!
              Repository: ${owner}/${repo}
              Workflow: ${workflow_name}
              Run #: ${run_number}
              Run URL: ${run_url}
              Failure Time: ${new Date().toISOString()}`;
            
            await github.rest.issues.create({
              owner,
              repo,
              title: `ğŸš¨ Workflow Failed - Run #${run_number}`,
              body: message,
              labels: ['workflow-failed', 'automated-report']
            });

      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            build
            node_modules
          key: ${{ runner.os }}-build-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-