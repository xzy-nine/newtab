name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·(å¦‚v1.0.0ï¼‰'
        required: true
        type: string
      release-id:
        description: 'Release IDï¼ˆè‡ªåŠ¨å‘å¸ƒæ—¶å¡«å†™ï¼‰'
        required: false
        type: string
      tag:
        description: 'è¦ä¼˜åŒ–å˜æ›´æ—¥å¿—çš„æ ‡ç­¾ï¼ˆæ‰‹åŠ¨ä¼˜åŒ–æ—¶å¡«å†™ï¼‰'
        required: false
        type: string
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        type: string
      release-id:
        description: 'Release ID'
        required: true
        type: string
    outputs:
      ai_optimized:
        description: "æ˜¯å¦å®ŒæˆAIä¼˜åŒ–"
        value: ${{ jobs.ai-changelog-generation.outputs.ai_optimized }}

jobs:
  ai-changelog-generation:
    name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      ai_optimized: ${{ steps.update-release-changelog.outputs.ai_optimized }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: éªŒè¯è¾“å…¥å‚æ•°
      id: validate-params
      run: |
        if [ "${{ github.event_name }}" == "workflow_call" ]; then
          echo "RUN_MODE=workflow_call" >> $GITHUB_ENV
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          echo "RELEASE_ID=${{ inputs.release-id }}" >> $GITHUB_ENV
          echo "ğŸ”— å·¥ä½œæµè°ƒç”¨æ¨¡å¼: ç‰ˆæœ¬ ${{ inputs.version }}, Release ID ${{ inputs.release-id }}"
        elif [ -n "${{ inputs.release-id }}" ]; then
          echo "RUN_MODE=auto_release" >> $GITHUB_ENV
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          echo "RELEASE_ID=${{ inputs.release-id }}" >> $GITHUB_ENV
          echo "ğŸ¤– è‡ªåŠ¨å‘å¸ƒæ¨¡å¼: ç‰ˆæœ¬ ${{ inputs.version }}, Release ID ${{ inputs.release-id }}"
        elif [ -n "${{ inputs.tag }}" ]; then
          echo "RUN_MODE=manual_optimize" >> $GITHUB_ENV
          echo "VERSION=${{ inputs.tag }}" >> $GITHUB_ENV
          echo "ğŸ“ æ‰‹åŠ¨ä¼˜åŒ–æ¨¡å¼: æ ‡ç­¾ ${{ inputs.tag }}"
        else
          echo "âŒ å¿…é¡»æä¾›å‘å¸ƒIDæˆ–æ ‡ç­¾å‚æ•°ä¹‹ä¸€"
          exit 1
        fi    

    - name: è·å–Releaseä¿¡æ¯
      id: get-release-info
      run: |
        if [ "${{ env.RUN_MODE }}" == "auto_release" ]; then
          # é€šè¿‡Release IDè·å–ä¿¡æ¯
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/${{ env.RELEASE_ID }}")
        else
          # é€šè¿‡æ ‡ç­¾è·å–ä¿¡æ¯
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ env.VERSION }}")
        fi
        
        # éªŒè¯æ˜¯å¦æˆåŠŸè·å–Releaseä¿¡æ¯
        if [[ $(echo "$RELEASE_INFO" | jq -r 'has("id")') != "true" ]]; then
          echo "âŒ æ— æ³•è·å–Releaseä¿¡æ¯: $(echo "$RELEASE_INFO" | jq -r '.message // "æœªçŸ¥é”™è¯¯"')"
          exit 1
        fi
        
        RELEASE_ID=$(echo "$RELEASE_INFO" | jq -r '.id')
        ORIGINAL_CHANGELOG=$(echo "$RELEASE_INFO" | jq -r '.body')
        
        echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
        echo "ORIGINAL_CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$ORIGINAL_CHANGELOG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "âœ… è·å–åˆ°Releaseä¿¡æ¯ï¼ŒID: $RELEASE_ID"
        echo "ğŸ“‹ åŸå§‹å˜æ›´æ—¥å¿—é•¿åº¦: $(echo "$ORIGINAL_CHANGELOG" | wc -c) å­—ç¬¦"    

    - name: æ£€æŸ¥æ˜¯å¦å·²ä¼˜(
      id: check-optimization-status
      run: |
        echo "ğŸ” æ£€æŸ¥å˜æ›´æ—¥å¿—ä¼˜åŒ–çŠ¶æ€..."
        
        # æ›´ä¸¥æ ¼çš„AIä¼˜åŒ–æ£€æŸ¥
        if [[ "$ORIGINAL_CHANGELOG" == *"AIç”Ÿæˆçš„å˜æ›´æ—¥å¿—æ‘˜è¦"* ]]; then
          echo "âš ï¸ æ­¤Releaseå·²åŒ…å«AIç”Ÿæˆçš„å˜æ›´æ—¥å¿—"
          
          if [ "${{ env.RUN_MODE }}" == "manual_optimize" ]; then
            echo "ğŸ“ æ‰‹åŠ¨æ¨¡å¼ï¼Œå¼ºåˆ¶é‡æ–°ç”ŸæˆAIå˜æ›´æ—¥å¿—"
            echo "NEED_OPTIMIZE=true" >> $GITHUB_ENV
            echo "FORCE_REGENERATE=true" >> $GITHUB_ENV
          else
            echo "ğŸ¤– è‡ªåŠ¨æ¨¡å¼ï¼Œè·³è¿‡é‡å¤ä¼˜åŒ–"
            echo "NEED_OPTIMIZE=false" >> $GITHUB_ENV
          fi
        else
          echo "âœ… å˜æ›´æ—¥å¿—æœªç»AIä¼˜åŒ–ï¼Œå¯ä»¥è¿›è¡Œä¼˜åŒ–"
          echo "NEED_OPTIMIZE=true" >> $GITHUB_ENV
        fi

    - name: è·å–è¯¦ç»†æäº¤ä¿¡æ¯
      id: get-detailed-commits
      if: env.NEED_OPTIMIZE == 'true'
      run: |
        echo "ğŸ“Š è·å–è¯¦ç»†çš„æäº¤ä¿¡æ¯..."
        
        if [ "${{ env.RUN_MODE }}" == "manual_optimize" ] && [ "${{ env.FORCE_REGENERATE }}" == "true" ]; then
          echo "ğŸ”„ æ‰‹åŠ¨ä¼˜åŒ–æ¨¡å¼ï¼Œä»æŠ˜å åŒºåŸŸæå–åŸå§‹æäº¤è®°å½•..."
          
          # ä»å˜æ›´æ—¥å¿—ä¸­æå–åŸå§‹æäº¤è®°å½•
          ORIGINAL_COMMITS=$(echo "$ORIGINAL_CHANGELOG" | sed -n '/<details>/,/<\/details>/p' | sed '1d;$d' | sed '/^<summary>/d' | sed '/^<\/summary>/d' | sed '/^$/d')
          
          if [ -n "$ORIGINAL_COMMITS" ]; then
            echo "âœ… ä»æŠ˜å åŒºåŸŸæå–åˆ°åŸå§‹æäº¤è®°å½•"
            echo "COMMITS_RAW<<EOF" >> $GITHUB_ENV
            echo "$ORIGINAL_COMMITS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            COMMIT_COUNT=$(echo "$ORIGINAL_COMMITS" | wc -l)
            echo "ğŸ“‹ ä½¿ç”¨æŠ˜å åŒºåŸŸä¸­çš„ $COMMIT_COUNT è¡Œæäº¤è®°å½•"
          else
            echo "âš ï¸ æ— æ³•ä»æŠ˜å åŒºåŸŸæå–åŸå§‹è®°å½•ï¼Œä½¿ç”¨Gitå†å²"
            # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„æ ‡ç­¾
            LAST_TAG=$(git tag --sort=-version:refname | grep -v "^${{ env.VERSION }}$" | head -1)
            
            if [ -z "$LAST_TAG" ]; then
              echo "ğŸ“‹ é¦–æ¬¡å‘å¸ƒï¼Œè·å–æ‰€æœ‰æäº¤è®°å½•"
              COMMIT_RANGE=""
            else
              echo "ğŸ“‹ è·å–è‡ª $LAST_TAG ä»¥æ¥çš„æäº¤è®°å½•"
              COMMIT_RANGE="$LAST_TAG..${{ env.VERSION }}"
            fi
            
            # è·å–è¯¦ç»†çš„æäº¤ä¿¡æ¯
            if [ -z "$COMMIT_RANGE" ]; then
              COMMITS=$(git log --pretty=format:'%h|%s|%b' --no-merges)
            else
              COMMITS=$(git log $COMMIT_RANGE --pretty=format:'%h|%s|%b' --no-merges)
            fi
            
            echo "COMMITS_RAW<<EOF" >> $GITHUB_ENV
            echo "$COMMITS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
            echo "âœ… è·å–åˆ° $COMMIT_COUNT ä¸ªæäº¤è®°å½•"
          fi
        else
          echo "ğŸ†• é¦–æ¬¡ç”Ÿæˆï¼Œä»Gitå†å²è·å–æäº¤è®°å½•..."
          
          # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„æ ‡ç­¾
          LAST_TAG=$(git tag --sort=-version:refname | grep -v "^${{ env.VERSION }}$" | head -1)
          
          if [ -z "$LAST_TAG" ]; then
            echo "ğŸ“‹ é¦–æ¬¡å‘å¸ƒï¼Œè·å–æ‰€æœ‰æäº¤è®°å½•"
            COMMIT_RANGE=""
          else
            echo "ğŸ“‹ è·å–è‡ª $LAST_TAG ä»¥æ¥çš„æäº¤è®°å½•"
            COMMIT_RANGE="$LAST_TAG..${{ env.VERSION }}"
          fi
          
          # è·å–è¯¦ç»†çš„æäº¤ä¿¡æ¯
          if [ -z "$COMMIT_RANGE" ]; then
            COMMITS=$(git log --pretty=format:'%h|%s|%b' --no-merges)
          else
            COMMITS=$(git log $COMMIT_RANGE --pretty=format:'%h|%s|%b' --no-merges)
          fi
          
          # ä¿å­˜æäº¤ä¿¡æ¯åˆ°ç¯å¢ƒå˜é‡
          echo "COMMITS_RAW<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
          echo "âœ… è·å–åˆ° $COMMIT_COUNT ä¸ªæäº¤è®°å½•"
        fi

    - name: åˆ†æå¹¶ç”ŸæˆAIå˜æ›´æ—¥å¿—
      id: generate-ai-changelog
      if: env.NEED_OPTIMIZE == 'true'
      run: |
        echo "ğŸ¤– å¼€å§‹ç”Ÿæˆç²¾ç¾çš„AIå˜æ›´æ—¥å¿—..."
        
        # åˆå§‹åŒ–å„ç±»åˆ«çš„æäº¤æ•°ç»„
        declare -a FEATURE_COMMITS=()
        declare -a FIX_COMMITS=()
        declare -a STYLE_COMMITS=()
        declare -a REFACTOR_COMMITS=()
        declare -a PERF_COMMITS=()
        declare -a DOCS_COMMITS=()
        declare -a BUILD_COMMITS=()
        declare -a OTHER_COMMITS=()
        
        # å¤„ç†ä»æŠ˜å åŒºåŸŸæå–çš„åŸå§‹è®°å½•æˆ–Gitå†å²è®°å½•
        if [ "${{ env.RUN_MODE }}" == "manual_optimize" ] && [ "${{ env.FORCE_REGENERATE }}" == "true" ]; then
          echo "ğŸ”„ å¤„ç†ä»æŠ˜å åŒºåŸŸæå–çš„åŸå§‹æäº¤è®°å½•..."
          
          # è§£æåŸå§‹è®°å½•ï¼ˆå¯èƒ½æ˜¯å¤šç§æ ¼å¼ï¼‰
          while IFS= read -r line; do
            if [[ -n "$line" && "$line" != *"<details>"* && "$line" != *"</details>"* && "$line" != *"<summary>"* && "$line" != *"</summary>"* ]]; then
              # å°è¯•ä»ä¸åŒæ ¼å¼ä¸­æå–ä¿¡æ¯
              if [[ "$line" =~ ^[[:space:]]*-[[:space:]]*([a-f0-9]{7,})[[:space:]]*(.+)$ ]]; then
                # æ ¼å¼: - hash message
                hash="${BASH_REMATCH[1]}"
                message="${BASH_REMATCH[2]}"
              elif [[ "$line" =~ ^[[:space:]]*([a-f0-9]{7,})[[:space:]]+(.+)$ ]]; then
                # æ ¼å¼: hash message
                hash="${BASH_REMATCH[1]}"
                message="${BASH_REMATCH[2]}"
              elif [[ "$line" =~ ^[[:space:]]*\*[[:space:]]*([a-f0-9]{7,})[[:space:]]*(.+)$ ]]; then
                # æ ¼å¼: * hash message
                hash="${BASH_REMATCH[1]}"
                message="${BASH_REMATCH[2]}"
              else
                # è·³è¿‡æ— æ³•è§£æçš„è¡Œ
                continue
              fi
              
              # æ¸…ç†æ¶ˆæ¯å†…å®¹
              clean_message=$(echo "$message" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              
              # åˆ†ç±»æäº¤
              if [[ "$clean_message" =~ ^(feat|feature|æ–°å¢|æ·»åŠ ) ]]; then
                FEATURE_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(fix|bug|ä¿®å¤|è§£å†³) ]]; then
                FIX_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(style|ui|æ ·å¼|ç•Œé¢) ]]; then
                STYLE_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(refactor|é‡æ„) ]]; then
                REFACTOR_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(perf|performance|ä¼˜åŒ–|æ€§èƒ½) ]]; then
                PERF_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(docs|doc|æ–‡æ¡£) ]]; then
                DOCS_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(build|ç‰ˆæœ¬|æ„å»º) ]]; then
                BUILD_COMMITS+=("$hash|$clean_message")
              else
                OTHER_COMMITS+=("$hash|$clean_message")
              fi
            fi
          done <<< "$COMMITS_RAW"
        else
          echo "ğŸ†• å¤„ç†Gitå†å²æäº¤è®°å½•..."
          
          # è§£æGitå†å²è®°å½•
          while IFS='|' read -r hash message body; do
            if [[ -n "$hash" ]]; then
              # æ¸…ç†æ¶ˆæ¯å†…å®¹
              clean_message=$(echo "$message" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              
              # åˆ†ç±»æäº¤
              if [[ "$clean_message" =~ ^(feat|feature|æ–°å¢|æ·»åŠ ) ]]; then
                FEATURE_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(fix|bug|ä¿®å¤|è§£å†³) ]]; then
                FIX_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(style|ui|æ ·å¼|ç•Œé¢) ]]; then
                STYLE_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(refactor|é‡æ„) ]]; then
                REFACTOR_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(perf|performance|ä¼˜åŒ–|æ€§èƒ½) ]]; then
                PERF_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(docs|doc|æ–‡æ¡£) ]]; then
                DOCS_COMMITS+=("$hash|$clean_message")
              elif [[ "$clean_message" =~ ^(build|ç‰ˆæœ¬|æ„å»º) ]]; then
                BUILD_COMMITS+=("$hash|$clean_message")
              else
                OTHER_COMMITS+=("$hash|$clean_message")
              fi
            fi
          done <<< "$COMMITS_RAW"
        fi
        
        # ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
        echo "ğŸ“Š æäº¤åˆ†ç±»ç»Ÿè®¡:"
        echo "  - åŠŸèƒ½æ–°å¢: ${#FEATURE_COMMITS[@]}"
        echo "  - é—®é¢˜ä¿®å¤: ${#FIX_COMMITS[@]}"
        echo "  - æ ·å¼ä¼˜åŒ–: ${#STYLE_COMMITS[@]}"
        echo "  - ä»£ç é‡æ„: ${#REFACTOR_COMMITS[@]}"
        echo "  - æ€§èƒ½ä¼˜åŒ–: ${#PERF_COMMITS[@]}"
        echo "  - æ–‡æ¡£æ›´æ–°: ${#DOCS_COMMITS[@]}"
        echo "  - æ„å»ºç›¸å…³: ${#BUILD_COMMITS[@]}"
        echo "  - å…¶ä»–æ”¹è¿›: ${#OTHER_COMMITS[@]}"
        
        # ä¿å­˜åŸå§‹è®°å½•ç”¨äºæŠ˜å åŒºåŸŸ
        if [ "${{ env.RUN_MODE }}" == "manual_optimize" ] && [ "${{ env.FORCE_REGENERATE }}" == "true" ]; then
          # ä½¿ç”¨å·²æœ‰çš„åŸå§‹è®°å½•
          ORIGINAL_FOR_COLLAPSE="$ORIGINAL_CHANGELOG"
        else
          # ä½¿ç”¨å½“å‰çš„åŸå§‹è®°å½•
          ORIGINAL_FOR_COLLAPSE="$ORIGINAL_CHANGELOG"
        fi
        
        # å¼€å§‹ç”Ÿæˆå˜æ›´æ—¥å¿—
        AI_CHANGELOG="# ç‰ˆæœ¬ ${{ env.VERSION }} æ›´æ–°æ‘˜è¦ [AIç”Ÿæˆçš„å˜æ›´æ—¥å¿—æ‘˜è¦]

        ---"
        
        # åŠŸèƒ½æ–°å¢éƒ¨åˆ†
        if [ ${#FEATURE_COMMITS[@]} -gt 0 ]; then
          AI_CHANGELOG="$AI_CHANGELOG

        #### åŠŸèƒ½æ–°å¢"
          
          for commit in "${FEATURE_COMMITS[@]}"; do
            IFS='|' read -r hash message <<< "$commit"
            # æå–å…³é”®è¯ä½œä¸ºæ ‡é¢˜
            title=$(echo "$message" | sed 's/^feat[[:space:]]*:[[:space:]]*//' | sed 's/^feature[[:space:]]*:[[:space:]]*//' | sed 's/æ–°å¢[[:space:]]*//' | sed 's/æ·»åŠ [[:space:]]*//')
            AI_CHANGELOG="$AI_CHANGELOG
        - **${title}**  
          \`$hash\`  
          $message"
          done
        fi
        
        # é—®é¢˜ä¿®å¤éƒ¨åˆ†
        if [ ${#FIX_COMMITS[@]} -gt 0 ]; then
          AI_CHANGELOG="$AI_CHANGELOG

        ---

        ####  é—®é¢˜ä¿®å¤"
          
          for commit in "${FIX_COMMITS[@]}"; do
            IFS='|' read -r hash message <<< "$commit"
            title=$(echo "$message" | sed 's/^fix[[:space:]]*:[[:space:]]*//' | sed 's/^bug[[:space:]]*:[[:space:]]*//' | sed 's/ä¿®å¤[[:space:]]*//' | sed 's/è§£å†³[[:space:]]*//')
            AI_CHANGELOG="$AI_CHANGELOG
        - **${title}**  
          \`$hash\`  
          $message"
          done
        fi
        
        # æ”¹è¿›ä¼˜åŒ–éƒ¨åˆ†
        improvement_sections=""
        
        # æ ·å¼ä¼˜åŒ–
        if [ ${#STYLE_COMMITS[@]} -gt 0 ]; then
          improvement_sections="$improvement_sections
        - **ç•Œé¢æ ·å¼ä¼˜åŒ–**  "
          for commit in "${STYLE_COMMITS[@]}"; do
            IFS='|' read -r hash message <<< "$commit"
            improvement_sections="$improvement_sections
          \`$hash\` "
          done
          improvement_sections="$improvement_sections 
          ç•Œé¢æ ·å¼å’Œè§†è§‰æ•ˆæœä¼˜åŒ–"
        fi
        
        # æ€§èƒ½ä¼˜åŒ–
        if [ ${#PERF_COMMITS[@]} -gt 0 ]; then
          improvement_sections="$improvement_sections
        - **æ€§èƒ½ä¼˜åŒ–**  "
          for commit in "${PERF_COMMITS[@]}"; do
            IFS='|' read -r hash message <<< "$commit"
            improvement_sections="$improvement_sections
          \`$hash\` "
          done
          improvement_sections="$improvement_sections 
          ç³»ç»Ÿæ€§èƒ½å’Œå“åº”é€Ÿåº¦ä¼˜åŒ–"
        fi
        
        # é‡æ„
        if [ ${#REFACTOR_COMMITS[@]} -gt 0 ]; then
          improvement_sections="$improvement_sections
        - **ä»£ç é‡æ„**  "
          for commit in "${REFACTOR_COMMITS[@]}"; do
            IFS='|' read -r hash message <<< "$commit"
            improvement_sections="$improvement_sections
          \`$hash\` "
          done
          improvement_sections="$improvement_sections 
          ä»£ç ç»“æ„ä¼˜åŒ–å’Œé‡æ„"
        fi
        
        # å…¶ä»–æ”¹è¿›
        if [ ${#OTHER_COMMITS[@]} -gt 0 ]; then
          improvement_sections="$improvement_sections
        - **å…¶ä»–æ”¹è¿›**  "
          for commit in "${OTHER_COMMITS[@]}"; do
            IFS='|' read -r hash message <<< "$commit"
            improvement_sections="$improvement_sections
          \`$hash\` "
          done
          improvement_sections="$improvement_sections 
          å…¶ä»–åŠŸèƒ½æ”¹è¿›å’Œä¼˜åŒ–"
        fi
        
        if [ -n "$improvement_sections" ]; then
          AI_CHANGELOG="$AI_CHANGELOG

        ---

        #### æ”¹è¿›ä¼˜åŒ–$improvement_sections"
        fi
        
        # ç‰ˆæœ¬æ„å»ºéƒ¨åˆ†
        if [ ${#BUILD_COMMITS[@]} -gt 0 ]; then
          AI_CHANGELOG="$AI_CHANGELOG

        ---

        **ç‰ˆæœ¬æ„å»º**  "
          for commit in "${BUILD_COMMITS[@]}"; do
            IFS='|' read -r hash message <<< "$commit"
            AI_CHANGELOG="$AI_CHANGELOG
        \`$hash\` $message"
          done
        fi
        
        # æ·»åŠ åŸå§‹å˜æ›´è®°å½•åˆ°æŠ˜å åŒºåŸŸ
        AI_CHANGELOG="$AI_CHANGELOG

        <details>
        <summary>æŸ¥çœ‹åŸå§‹æäº¤è®°å½•</summary>

        $ORIGINAL_FOR_COLLAPSE

        </details>"
        
        # ä¿å­˜ç”Ÿæˆçš„å˜æ›´æ—¥å¿—
        echo "AI_CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$AI_CHANGELOG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "âœ… AIå˜æ›´æ—¥å¿—ç”Ÿæˆå®Œæˆ"
        echo "ğŸ“ å˜æ›´æ—¥å¿—é•¿åº¦: $(echo "$AI_CHANGELOG" | wc -c) å­—ç¬¦"
        
        # è¾“å‡ºæ¨¡å¼è¯´æ˜
        if [ "${{ env.RUN_MODE }}" == "manual_optimize" ] && [ "${{ env.FORCE_REGENERATE }}" == "true" ]; then
          echo "ğŸ”„ ä½¿ç”¨æŠ˜å åŒºåŸŸä¸­çš„åŸå§‹æäº¤è®°å½•é‡æ–°ç”Ÿæˆ"
        else
          echo "ğŸ†• ä½¿ç”¨Gitå†å²è®°å½•é¦–æ¬¡ç”Ÿæˆ"
        fi
    - name: æ›´æ–°Releaseå˜æ›´æ—¥å¿—
      id: update-release-changelog
      if: env.NEED_OPTIMIZE == 'true'
      run: |
        echo "ğŸ“ æ›´æ–°Releaseå˜æ›´æ—¥å¿—..."
        
        # ä½¿ç”¨GitHub APIæ›´æ–°Release
        UPDATE_RESPONSE=$(curl -s -X PATCH \
          -H "Authorization: token ${{ secrets.PAT }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases/${{ env.RELEASE_ID }}" \
          -d "{\"body\": $(echo "$AI_CHANGELOG" | jq -R -s '.')}")
        
        # æ£€æŸ¥æ›´æ–°ç»“æœ
        if [[ $(echo "$UPDATE_RESPONSE" | jq -r 'has("id")') == "true" ]]; then
          echo "âœ… Releaseå˜æ›´æ—¥å¿—æ›´æ–°æˆåŠŸ"
          echo "ğŸ”— Release URL: $(echo "$UPDATE_RESPONSE" | jq -r '.html_url')"
          echo "ai_optimized=true" >> $GITHUB_OUTPUT
          
          # æ·»åŠ åˆ°ä½œä¸šæ‘˜è¦
          echo "## ğŸ¤– AIå˜æ›´æ—¥å¿—ç”Ÿæˆå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | \`${{ env.VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release ID | \`${{ env.RELEASE_ID }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release URL | [æŸ¥çœ‹å‘å¸ƒ]($(echo "$UPDATE_RESPONSE" | jq -r '.html_url')) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Releaseå˜æ›´æ—¥å¿—æ›´æ–°å¤±è´¥"
          echo "é”™è¯¯ä¿¡æ¯: $(echo "$UPDATE_RESPONSE" | jq -r '.message // "æœªçŸ¥é”™è¯¯"')"
          echo "ai_optimized=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        find . -name "*.tmp" -delete 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"