name: AI变更日志生成

on:
  workflow_dispatch:
    inputs:
      target:
        description: '目标版本或标签（如：v1.0.0 或 latest）'
        required: true
        type: string
        default: 'latest'
  workflow_call:
    inputs:
      version:
        description: '版本号'
        required: true
        type: string
      release-id:
        description: 'Release ID'
        required: true
        type: string
    outputs:
      ai_optimized:
        description: "是否完成AI优化"
        value: ${{ jobs.ai-changelog-generation.outputs.ai_optimized }}
      ai_success:
        description: "AI是否成功调用"
        value: ${{ jobs.ai-changelog-generation.outputs.ai_success }}
      total_commits:
        description: "处理的提交总数"
        value: ${{ jobs.ai-changelog-generation.outputs.total_commits }}

jobs:
  ai-changelog-generation:
    name: AI变更日志生成
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      ai_optimized: ${{ steps.run-generator.outputs.ai_optimized }}
      ai_success: ${{ steps.run-generator.outputs.ai_success }}
      total_commits: ${{ steps.run-generator.outputs.total_commits }}
      generation_mode: ${{ steps.run-generator.outputs.generation_mode }}

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: 安装Python依赖
      run: |
        pip install -r .github/workflows/ai-log-work-py/requirements.txt

    - name: 运行AI变更日志生成器
      id: run-generator
      run: |
        cd .github/workflows/ai-log-work-py
        
        echo "🚀 开始执行AI变更日志生成..."
        
        # 根据触发方式设置参数
        if [ "${{ github.event_name }}" = "workflow_call" ]; then
          # 自动触发模式
          echo "🤖 自动触发模式"
          echo "📋 版本: ${{ inputs.version }}"
          echo "🏷️ Release ID: ${{ inputs.release-id }}"
          
          python changelog.py \
            --version "${{ inputs.version }}" \
            --release-id "${{ inputs.release-id }}" \
            --event-name "${{ github.event_name }}" \
            --repo "${{ github.repository }}" \
            --github-token "${{ secrets.PAT }}" \
            --deepseek-api-key "${{ secrets.DEEPSEEK_API_KEY }}"
        else
          # 手动触发模式
          echo "📝 手动触发模式"
          echo "🎯 目标: ${{ inputs.target }}"
          
          python changelog.py \
            --target "${{ inputs.target }}" \
            --event-name "${{ github.event_name }}" \
            --repo "${{ github.repository }}" \
            --github-token "${{ secrets.PAT }}" \
            --deepseek-api-key "${{ secrets.DEEPSEEK_API_KEY }}"
        fi
        
        # 设置输出变量
        exit_code=$?
        if [ $exit_code -eq 0 ]; then
          echo "ai_optimized=true" >> $GITHUB_OUTPUT
          echo "✅ AI变更日志生成完成"
        else
          echo "ai_optimized=false" >> $GITHUB_OUTPUT
          echo "❌ AI变更日志生成失败"
        fi
        
        exit $exit_code

    - name: 输出执行结果
      if: always()
      run: |
        echo "## 🎯 执行结果摘要" >> $GITHUB_STEP_SUMMARY
        echo "| 项目 | 结果 |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" = "workflow_call" ]; then
          echo "| 执行模式 | 🤖 自动触发 |" >> $GITHUB_STEP_SUMMARY
          echo "| 版本号 | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| 执行模式 | 📝 手动触发 |" >> $GITHUB_STEP_SUMMARY
          echo "| 目标版本 | \`${{ inputs.target }}\` |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "| 执行状态 | ${{ steps.run-generator.outcome == 'success' && '✅ 成功' || '❌ 失败' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AI优化 | ${{ steps.run-generator.outputs.ai_optimized == 'true' && '✅ 已完成' || '❌ 未完成' }} |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.run-generator.outputs.ai_success }}" = "true" ]; then
          echo "| AI状态 | 🧠 AI智能生成 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| AI状态 | 📝 基础规则生成 |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.run-generator.outputs.total_commits }}" != "" ]; then
          echo "| 处理提交数 | ${{ steps.run-generator.outputs.total_commits }} |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: 清理临时文件
      if: always()
      run: |
        find . -name "*.tmp" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
