name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡ç‰ˆæœ¬æˆ–æ ‡ç­¾ï¼ˆå¦‚ï¼šv1.0.0 æˆ– latestï¼‰'
        required: true
        type: string
        default: 'latest'
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        type: string
      release-id:
        description: 'Release ID'
        required: true
        type: string
    outputs:
      ai_optimized:
        description: "æ˜¯å¦å®ŒæˆAIä¼˜åŒ–"
        value: ${{ jobs.ai-changelog-generation.outputs.ai_optimized }}
      ai_success:
        description: "AIæ˜¯å¦æˆåŠŸè°ƒç”¨"
        value: ${{ jobs.ai-changelog-generation.outputs.ai_success }}
      total_commits:
        description: "å¤„ç†çš„æäº¤æ€»æ•°"
        value: ${{ jobs.ai-changelog-generation.outputs.total_commits }}

jobs:
  ai-changelog-generation:
    name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      ai_optimized: ${{ steps.run-generator.outputs.ai_optimized }}
      ai_success: ${{ steps.run-generator.outputs.ai_success }}
      total_commits: ${{ steps.run-generator.outputs.total_commits }}
      generation_mode: ${{ steps.run-generator.outputs.generation_mode }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        pip install -r .github/workflows/ai-log-work-py/requirements.txt

    - name: è¿è¡ŒAIå˜æ›´æ—¥å¿—ç”Ÿæˆå™¨
      id: run-generator
      run: |
        cd .github/workflows/ai-log-work-py
        
        echo "ðŸš€ å¼€å§‹æ‰§è¡ŒAIå˜æ›´æ—¥å¿—ç”Ÿæˆ..."
        
        # æ ¹æ®è§¦å‘æ–¹å¼è®¾ç½®å‚æ•°
        if [ "${{ github.event_name }}" = "workflow_call" ]; then
          # è‡ªåŠ¨è§¦å‘æ¨¡å¼
          echo "ðŸ¤– è‡ªåŠ¨è§¦å‘æ¨¡å¼"
          echo "ðŸ“‹ ç‰ˆæœ¬: ${{ inputs.version }}"
          echo "ðŸ·ï¸ Release ID: ${{ inputs.release-id }}"
          
          python changelog.py \
            --version "${{ inputs.version }}" \
            --release-id "${{ inputs.release-id }}" \
            --event-name "${{ github.event_name }}" \
            --repo "${{ github.repository }}" \
            --github-token "${{ secrets.PAT }}" \
            --deepseek-api-key "${{ secrets.DEEPSEEK_API_KEY }}"
        else
          # æ‰‹åŠ¨è§¦å‘æ¨¡å¼
          echo "ðŸ“ æ‰‹åŠ¨è§¦å‘æ¨¡å¼"
          echo "ðŸŽ¯ ç›®æ ‡: ${{ inputs.target }}"
          
          python changelog.py \
            --target "${{ inputs.target }}" \
            --event-name "${{ github.event_name }}" \
            --repo "${{ github.repository }}" \
            --github-token "${{ secrets.PAT }}" \
            --deepseek-api-key "${{ secrets.DEEPSEEK_API_KEY }}"
        fi
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        exit_code=$?
        if [ $exit_code -eq 0 ]; then
          echo "ai_optimized=true" >> $GITHUB_OUTPUT
          echo "âœ… AIå˜æ›´æ—¥å¿—ç”Ÿæˆå®Œæˆ"
        else
          echo "ai_optimized=false" >> $GITHUB_OUTPUT
          echo "âŒ AIå˜æ›´æ—¥å¿—ç”Ÿæˆå¤±è´¥"
        fi
        
        exit $exit_code

    - name: è¾“å‡ºæ‰§è¡Œç»“æžœ
      if: always()
      run: |
        echo "## ðŸŽ¯ æ‰§è¡Œç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | ç»“æžœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" = "workflow_call" ]; then
          echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ¤– è‡ªåŠ¨è§¦å‘ |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬å· | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ“ æ‰‹åŠ¨è§¦å‘ |" >> $GITHUB_STEP_SUMMARY
          echo "| ç›®æ ‡ç‰ˆæœ¬ | \`${{ inputs.target }}\` |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "| æ‰§è¡ŒçŠ¶æ€ | ${{ steps.run-generator.outcome == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AIä¼˜åŒ– | ${{ steps.run-generator.outputs.ai_optimized == 'true' && 'âœ… å·²å®Œæˆ' || 'âŒ æœªå®Œæˆ' }} |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.run-generator.outputs.ai_success }}" = "true" ]; then
          echo "| AIçŠ¶æ€ | ðŸ§  AIæ™ºèƒ½ç”Ÿæˆ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| AIçŠ¶æ€ | ðŸ“ åŸºç¡€è§„åˆ™ç”Ÿæˆ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.run-generator.outputs.total_commits }}" != "" ]; then
          echo "| å¤„ç†æäº¤æ•° | ${{ steps.run-generator.outputs.total_commits }} |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        find . -name "*.tmp" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
