name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·(å¦‚v1.0.0ï¼‰'
        required: true
        type: string
      release-id:
        description: 'Release IDï¼ˆè‡ªåŠ¨å‘å¸ƒæ—¶å¡«å†™ï¼‰'
        required: false
        type: string
      tag:
        description: 'è¦ä¼˜åŒ–å˜æ›´æ—¥å¿—çš„æ ‡ç­¾ï¼ˆæ‰‹åŠ¨ä¼˜åŒ–æ—¶å¡«å†™ï¼‰'
        required: false
        type: string
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        type: string
      release-id:
        description: 'Release ID'
        required: true
        type: string
    outputs:
      ai_optimized:
        description: "æ˜¯å¦å®ŒæˆAIä¼˜åŒ–"
        value: ${{ jobs.ai-changelog-generation.outputs.ai_optimized }}

jobs:
  ai-changelog-generation:
    name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      ai_optimized: ${{ steps.update-release-changelog.outputs.ai_optimized }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: éªŒè¯è¾“å…¥å‚æ•°
      id: validate-params
      run: |
        echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
        if [ "${{ github.event_name }}" == "workflow_call" ]; then
          echo "RUN_MODE=workflow_call" >> $GITHUB_ENV
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          echo "RELEASE_ID=${{ inputs.release-id }}" >> $GITHUB_ENV
          echo "ğŸ”— å·¥ä½œæµè°ƒç”¨æ¨¡å¼: ç‰ˆæœ¬ ${{ inputs.version }}, Release ID ${{ inputs.release-id }}"
        elif [ -n "${{ inputs.release-id }}" ]; then
          echo "RUN_MODE=auto_release" >> $GITHUB_ENV
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          echo "RELEASE_ID=${{ inputs.release-id }}" >> $GITHUB_ENV
          echo "ğŸ¤– è‡ªåŠ¨å‘å¸ƒæ¨¡å¼: ç‰ˆæœ¬ ${{ inputs.version }}, Release ID ${{ inputs.release-id }}"
        elif [ -n "${{ inputs.tag }}" ]; then
          echo "RUN_MODE=manual_optimize" >> $GITHUB_ENV
          echo "VERSION=${{ inputs.tag }}" >> $GITHUB_ENV
          echo "ğŸ“ æ‰‹åŠ¨ä¼˜åŒ–æ¨¡å¼: æ ‡ç­¾ ${{ inputs.tag }}"
        else
          echo "âŒ å¿…é¡»æä¾›å‘å¸ƒIDæˆ–æ ‡ç­¾å‚æ•°ä¹‹ä¸€"
          exit 1
        fi    

    - name: è·å–Releaseä¿¡æ¯
      id: get-release-info
      run: |
        if [ "${{ env.RUN_MODE }}" == "auto_release" ]; then
          # é€šè¿‡Release IDè·å–ä¿¡æ¯
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/${{ env.RELEASE_ID }}")
        else
          # é€šè¿‡æ ‡ç­¾è·å–ä¿¡æ¯
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ env.VERSION }}")
        fi
        
        # éªŒè¯æ˜¯å¦æˆåŠŸè·å–Releaseä¿¡æ¯
        if [[ $(echo "$RELEASE_INFO" | jq -r 'has("id")') != "true" ]]; then
          echo "âŒ æ— æ³•è·å–Releaseä¿¡æ¯: $(echo "$RELEASE_INFO" | jq -r '.message // "æœªçŸ¥é”™è¯¯"')"
          exit 1
        fi
        
        RELEASE_ID=$(echo "$RELEASE_INFO" | jq -r '.id')
        ORIGINAL_CHANGELOG=$(echo "$RELEASE_INFO" | jq -r '.body')
        
        echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
        echo "ORIGINAL_CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$ORIGINAL_CHANGELOG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "âœ… è·å–åˆ°Releaseä¿¡æ¯ï¼ŒID: $RELEASE_ID"
        echo "ğŸ“‹ åŸå§‹å˜æ›´æ—¥å¿—é•¿åº¦: $(echo "$ORIGINAL_CHANGELOG" | wc -c) å­—ç¬¦"

    - name: æ£€æŸ¥æ˜¯å¦å·²ä¼˜åŒ–
      id: check-optimization-status
      run: |
        echo "ğŸ” æ£€æŸ¥å˜æ›´æ—¥å¿—ä¼˜åŒ–çŠ¶æ€..."
        
        if [ "${{ env.RUN_MODE }}" == "manual_optimize" ]; then
          echo "ğŸ“ æ‰‹åŠ¨ä¼˜åŒ–æ¨¡å¼ï¼šå¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼Œæå–åŸå§‹å†…å®¹"
          echo "NEED_OPTIMIZE=true" >> $GITHUB_ENV
          echo "FORCE_REGENERATE=true" >> $GITHUB_ENV
          
          # æå–åŸå§‹çš„æäº¤è®°å½•
          echo "ğŸ” æå–åŸå§‹æäº¤è®°å½•..."
          
          if [[ "$ORIGINAL_CHANGELOG" == *"<details>"*"æŸ¥çœ‹åŸå§‹æäº¤è®°å½•"*"</details>"* ]]; then
            echo "ğŸ“‹ å‘ç°æŠ˜å åŒºåŸŸï¼Œæå–åŸå§‹æäº¤è®°å½•..."
            
            # æå– <details> æ ‡ç­¾å†…çš„å†…å®¹
            EXTRACTED_CONTENT=$(echo "$ORIGINAL_CHANGELOG" | sed -n '/<details>/,/<\/details>/p')
            
            # ç§»é™¤ <details>, <summary>, </summary>, </details> æ ‡ç­¾
            CLEAN_ORIGINAL=$(echo "$EXTRACTED_CONTENT" | sed '/<details>/d' | sed '/<\/details>/d' | sed '/<summary>.*<\/summary>/d' | sed '/^$/d')
            
            # å¦‚æœæå–çš„å†…å®¹ä¸ºç©ºæˆ–åªæœ‰ç©ºç™½ï¼Œåˆ™ä»Gitå†å²è·å–
            if [[ -z "$(echo "$CLEAN_ORIGINAL" | sed '/^[[:space:]]*$/d')" ]]; then
              echo "âš ï¸ æŠ˜å åŒºåŸŸå†…å®¹ä¸ºç©ºï¼Œå°†ä»Gitå†å²é‡æ–°è·å–"
              CLEAN_ORIGINAL=""
            else
              echo "âœ… æˆåŠŸæå–åˆ°åŸå§‹æäº¤è®°å½•"
            fi
          else
            echo "â„¹ï¸ æœªå‘ç°AIä¼˜åŒ–æ ‡è®°ï¼Œä½¿ç”¨åŸå§‹å†…å®¹"
            CLEAN_ORIGINAL="$ORIGINAL_CHANGELOG"
          fi
          
          # æ›´æ–°ç¯å¢ƒå˜é‡
          echo "ORIGINAL_CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$CLEAN_ORIGINAL" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "âœ… æ‰‹åŠ¨æ¨¡å¼å‡†å¤‡å®Œæˆ"
          
        else
          # è‡ªåŠ¨æ¨¡å¼çš„åŸæœ‰é€»è¾‘
          if [[ "$ORIGINAL_CHANGELOG" == *"AIç”Ÿæˆçš„å˜æ›´æ—¥å¿—æ‘˜è¦"* ]]; then
            echo "âš ï¸ æ­¤Releaseå·²åŒ…å«AIç”Ÿæˆçš„å˜æ›´æ—¥å¿—"
            echo "ğŸ¤– è‡ªåŠ¨æ¨¡å¼ï¼Œè·³è¿‡é‡å¤ä¼˜åŒ–"
            echo "NEED_OPTIMIZE=false" >> $GITHUB_ENV
          else
            echo "âœ… å˜æ›´æ—¥å¿—æœªç»AIä¼˜åŒ–ï¼Œå¯ä»¥è¿›è¡Œä¼˜åŒ–"
            echo "NEED_OPTIMIZE=true" >> $GITHUB_ENV
          fi
        fi

    - name: è·å–è¯¦ç»†æäº¤ä¿¡æ¯
      id: get-detailed-commits
      if: env.NEED_OPTIMIZE == 'true'
      run: |
        echo "ğŸ“Š è·å–è¯¦ç»†çš„æäº¤ä¿¡æ¯..."
        
        # è·å–Gitæäº¤å†å²
        CURRENT_TAG="${{ env.VERSION }}"
        echo "ğŸ¯ å½“å‰ç‰ˆæœ¬: $CURRENT_TAG"
        
        # ä¿®å¤ï¼šè·å–ä¸Šä¸€ä¸ªæ­£ç¡®çš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œæ’é™¤å½“å‰æ ‡ç­¾ï¼Œå¹¶æŒ‰ç‰ˆæœ¬å·æ­£ç¡®æ’åº
        LAST_TAG=$(git tag --sort=-version:refname | grep -E '^v?[0-9]+\.[0-9]+(\.[0-9]+)?.*$' | grep -v "^$CURRENT_TAG$" | head -1)
        
        if [ -z "$LAST_TAG" ]; then
          echo "ğŸ“‹ é¦–æ¬¡å‘å¸ƒï¼Œè·å–åˆ°å½“å‰ç‰ˆæœ¬çš„æ‰€æœ‰æäº¤è®°å½•"
          # è·å–å½“å‰æ ‡ç­¾çš„æ‰€æœ‰æäº¤
          COMMITS=$(git log $CURRENT_TAG --pretty=format:'%h|%s|%b' --no-merges)
          COMMIT_RANGE="åˆå§‹ç‰ˆæœ¬åˆ°$CURRENT_TAG"
        else
          echo "ğŸ“‹ è·å– $LAST_TAG åˆ° $CURRENT_TAG ä¹‹é—´çš„æäº¤è®°å½•"
          COMMIT_RANGE="$LAST_TAG..$CURRENT_TAG"
          COMMITS=$(git log $COMMIT_RANGE --pretty=format:'%h|%s|%b' --no-merges)
        fi
        
        # ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—æäº¤æ•°é‡ï¼Œå»é™¤æ¢è¡Œç¬¦
        COMMIT_COUNT=$(echo "$COMMITS" | grep -c "^[a-f0-9]" 2>/dev/null || echo "0")
        COMMIT_COUNT=$(echo "$COMMIT_COUNT" | tr -d '\n\r' | head -1)
        echo "âœ… è·å–åˆ° $COMMIT_COUNT ä¸ªæäº¤è®°å½•"
        
        # ä¿®å¤ï¼šå¦‚æœæ²¡æœ‰è·å–åˆ°æäº¤è®°å½•ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
        if [ "$COMMIT_COUNT" -eq 0 ]; then
          echo "âš ï¸ æœªè·å–åˆ°æäº¤è®°å½•ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
          
          # æ–¹æ³•1ï¼šæ£€æŸ¥å½“å‰æ ‡ç­¾æ˜¯å¦å­˜åœ¨
          if ! git rev-parse "$CURRENT_TAG" >/dev/null 2>&1; then
            echo "âŒ æ ‡ç­¾ $CURRENT_TAG ä¸å­˜åœ¨"
            echo "å¯ç”¨çš„æ ‡ç­¾ï¼š"
            git tag --sort=-version:refname | head -10
            exit 1
          fi
          
          # æ–¹æ³•2ï¼šå¦‚æœæœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œæ£€æŸ¥æ ‡ç­¾ç‰ˆæœ¬é¡ºåºï¼ˆä¿®å¤ç‰ˆæœ¬æ¯”è¾ƒé€»è¾‘ï¼‰
          if [ -n "$LAST_TAG" ]; then
            echo "ğŸ” éªŒè¯æ ‡ç­¾ç‰ˆæœ¬é¡ºåº..."
            
            # ä½¿ç”¨ç‰ˆæœ¬å·æ¯”è¾ƒè€Œä¸æ˜¯æ—¶é—´æ¯”è¾ƒ
            # æ£€æŸ¥å½“å‰ç‰ˆæœ¬æ˜¯å¦ç¡®å®æ¯”ä¸Šä¸€ç‰ˆæœ¬æ–°
            CURRENT_VERSION=$(echo "$CURRENT_TAG" | sed 's/^v//')
            LAST_VERSION=$(echo "$LAST_TAG" | sed 's/^v//')
            
            # ä½¿ç”¨sortè¿›è¡Œç‰ˆæœ¬å·æ¯”è¾ƒ
            NEWER_VERSION=$(printf "%s\n%s\n" "$CURRENT_VERSION" "$LAST_VERSION" | sort -V | tail -1)
            
            if [ "$NEWER_VERSION" != "$CURRENT_VERSION" ]; then
              echo "âš ï¸ æ£€æµ‹åˆ°ç‰ˆæœ¬é¡ºåºå¼‚å¸¸: å½“å‰ç‰ˆæœ¬($CURRENT_TAG)ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œä¸Šä¸€ç‰ˆæœ¬æ˜¯($LAST_TAG)"
              echo "ğŸ”„ é‡æ–°æŸ¥æ‰¾æ­£ç¡®çš„ç‰ˆæœ¬èŒƒå›´..."
              
              # é‡æ–°è·å–ç‰ˆæœ¬æ ‡ç­¾ï¼Œæ‰¾åˆ°æ¯”å½“å‰ç‰ˆæœ¬æ›´æ—§çš„æœ€æ–°æ ‡ç­¾
              OLDER_TAG=$(git tag --sort=-version:refname | grep -E '^v?[0-9]+\.[0-9]+(\.[0-9]+)?.*$' | while read tag; do
                TAG_VERSION=$(echo "$tag" | sed 's/^v//')
                COMPARE_RESULT=$(printf "%s\n%s\n" "$TAG_VERSION" "$CURRENT_VERSION" | sort -V | tail -1)
                if [ "$COMPARE_RESULT" = "$CURRENT_VERSION" ] && [ "$tag" != "$CURRENT_TAG" ]; then
                  echo "$tag"
                  break
                fi
              done)
              
              if [ -n "$OLDER_TAG" ]; then
                echo "âœ… æ‰¾åˆ°æ­£ç¡®çš„æ¯”è¾ƒç‰ˆæœ¬: $OLDER_TAG"
                LAST_TAG="$OLDER_TAG"
                COMMIT_RANGE="$LAST_TAG..$CURRENT_TAG"
                COMMITS=$(git log "$COMMIT_RANGE" --pretty=format:'%h|%s|%b' --no-merges)
              else
                echo "ğŸ“‹ æœªæ‰¾åˆ°åˆé€‚çš„æ¯”è¾ƒç‰ˆæœ¬ï¼Œè·å–å½“å‰ç‰ˆæœ¬çš„æ‰€æœ‰æäº¤"
                COMMITS=$(git log "$CURRENT_TAG" --pretty=format:'%h|%s|%b' --no-merges | head -20)
                COMMIT_RANGE="å½“å‰ç‰ˆæœ¬çš„æ‰€æœ‰æäº¤"
                LAST_TAG=""
              fi
            else
              echo "ğŸ”„ é‡æ–°å°è¯•è·å–æäº¤è®°å½•..."
              COMMITS=$(git log "$LAST_TAG..$CURRENT_TAG" --pretty=format:'%h|%s|%b' --no-merges)
            fi
          else
            echo "ğŸ”„ è·å–å½“å‰æ ‡ç­¾çš„æ‰€æœ‰æäº¤..."
            COMMITS=$(git log "$CURRENT_TAG" --pretty=format:'%h|%s|%b' --no-merges | head -20)
            COMMIT_RANGE="å½“å‰æ ‡ç­¾çš„æ‰€æœ‰æäº¤"
          fi
          
          # é‡æ–°è®¡ç®—æäº¤æ•°é‡
          COMMIT_COUNT=$(echo "$COMMITS" | grep -c "^[a-f0-9]" 2>/dev/null || echo "0")
          COMMIT_COUNT=$(echo "$COMMIT_COUNT" | tr -d '\n\r' | head -1)
          echo "ğŸ”„ é‡æ–°è·å–åˆ° $COMMIT_COUNT ä¸ªæäº¤è®°å½•"
        fi
        
        # å¦‚æœæäº¤æ•°é‡å¼‚å¸¸å¤šï¼ˆè¶…è¿‡100ä¸ªï¼‰ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬è¯†åˆ«æœ‰é—®é¢˜
        if [ "$COMMIT_COUNT" -gt 100 ]; then
          echo "âš ï¸ æäº¤æ•°é‡å¼‚å¸¸($COMMIT_COUNTä¸ª)ï¼Œé‡æ–°å°è¯•è·å–æœ€è¿‘çš„ç‰ˆæœ¬æ ‡ç­¾"
          # å°è¯•è·å–æœ€è¿‘çš„10ä¸ªæ ‡ç­¾ï¼Œæ‰‹åŠ¨ç­›é€‰
          RECENT_TAGS=$(git tag --sort=-version:refname | head -10)
          echo "æœ€è¿‘çš„æ ‡ç­¾: $RECENT_TAGS"
          
          # é‡æ–°å°è¯•æ‰¾åˆ°æ­£ç¡®çš„ä¸Šä¸€ç‰ˆæœ¬ï¼ˆç¡®ä¿æ˜¯æ¯”å½“å‰ç‰ˆæœ¬æ—§çš„ç‰ˆæœ¬ï¼‰
          CURRENT_VERSION=$(echo "$CURRENT_TAG" | sed 's/^v//')
          CORRECT_LAST_TAG=""
          
          echo "$RECENT_TAGS" | while read tag; do
            if [ "$tag" != "$CURRENT_TAG" ]; then
              TAG_VERSION=$(echo "$tag" | sed 's/^v//')
              COMPARE_RESULT=$(printf "%s\n%s\n" "$TAG_VERSION" "$CURRENT_VERSION" | sort -V | tail -1)
              if [ "$COMPARE_RESULT" = "$CURRENT_VERSION" ]; then
                CORRECT_LAST_TAG="$tag"
                break
              fi
            fi
          done
          
          if [ -n "$CORRECT_LAST_TAG" ]; then
            echo "ğŸ”„ é‡æ–°è®¡ç®—æäº¤èŒƒå›´: $CORRECT_LAST_TAG..$CURRENT_TAG"
            COMMIT_RANGE="$CORRECT_LAST_TAG..$CURRENT_TAG"
            COMMITS=$(git log "$COMMIT_RANGE" --pretty=format:'%h|%s|%b' --no-merges)
            COMMIT_COUNT=$(echo "$COMMITS" | grep -c "^[a-f0-9]" 2>/dev/null || echo "0")
            COMMIT_COUNT=$(echo "$COMMIT_COUNT" | tr -d '\n\r' | head -1)
            LAST_TAG="$CORRECT_LAST_TAG"
            echo "âœ… é‡æ–°è·å–åˆ° $COMMIT_COUNT ä¸ªæäº¤è®°å½•"
          else
            echo "âš ï¸ æ— æ³•æ‰¾åˆ°åˆé€‚çš„æ¯”è¾ƒç‰ˆæœ¬ï¼Œä½¿ç”¨å½“å‰ç‰ˆæœ¬çš„æœ€è¿‘æäº¤"
            COMMITS=$(git log "$CURRENT_TAG" --pretty=format:'%h|%s|%b' --no-merges | head -30)
            COMMIT_COUNT=$(echo "$COMMITS" | grep -c "^[a-f0-9]" 2>/dev/null || echo "0")
            COMMIT_COUNT=$(echo "$COMMIT_COUNT" | tr -d '\n\r' | head -1)
            COMMIT_RANGE="å½“å‰ç‰ˆæœ¬çš„æœ€è¿‘30ä¸ªæäº¤"
            LAST_TAG=""
            echo "ğŸ“‹ è·å–åˆ° $COMMIT_COUNT ä¸ªæäº¤è®°å½•"
          fi
        fi
        
        # æœ€ç»ˆæ£€æŸ¥
        if [ "$COMMIT_COUNT" -eq 0 ]; then
          echo "âŒ ä»ç„¶æ— æ³•è·å–åˆ°æœ‰æ•ˆçš„æäº¤è®°å½•"
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š"
          echo "  - å½“å‰æ ‡ç­¾: $CURRENT_TAG"
          echo "  - ä¸Šä¸€æ ‡ç­¾: $LAST_TAG"
          echo "  - æäº¤èŒƒå›´: $COMMIT_RANGE"
          echo "  - Git ä»“åº“çŠ¶æ€ï¼š"
          git status --porcelain
          echo "  - æœ€è¿‘çš„æ ‡ç­¾ï¼ˆæŒ‰ç‰ˆæœ¬æ’åºï¼‰ï¼š"
          git tag --sort=-version:refname | head -5
          echo "  - å½“å‰åˆ†æ”¯ï¼š"
          git branch --show-current
          
          # ä½œä¸ºæœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼Œè·å–æœ€è¿‘çš„ä¸€äº›æäº¤
          echo "ğŸš¨ ä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆï¼šè·å–æœ€è¿‘çš„æäº¤è®°å½•"
          COMMITS=$(git log --oneline -n 10 --pretty=format:'%h|%s|%b')
          COMMIT_COUNT=$(echo "$COMMITS" | grep -c "^[a-f0-9]" 2>/dev/null || echo "0")
          COMMIT_COUNT=$(echo "$COMMIT_COUNT" | tr -d '\n\r' | head -1)
          COMMIT_RANGE="æœ€è¿‘10ä¸ªæäº¤"
          echo "ğŸ“‹ å¤‡é€‰æ–¹æ¡ˆè·å–åˆ° $COMMIT_COUNT ä¸ªæäº¤è®°å½•"
        fi
        
        # ä¿®å¤ï¼šæ­£ç¡®è®¾ç½®å¤šè¡Œç¯å¢ƒå˜é‡
        {
          echo "COMMITS_RAW<<EOF"
          echo "$COMMITS"
          echo "EOF"
        } >> $GITHUB_ENV
        
        # ä¿å­˜åŸå§‹å˜æ›´æ—¥å¿—ç”¨äºæŠ˜å æ˜¾ç¤º
        {
          echo "RAW_ORIGINAL_FOR_COLLAPSE<<EOF"
          if [[ -n "$ORIGINAL_CHANGELOG" && "$ORIGINAL_CHANGELOG" != "null" && "$ORIGINAL_CHANGELOG" != "" ]]; then
            echo "$ORIGINAL_CHANGELOG"
          else
            echo "## æäº¤è®°å½•"
            echo ""
            if [[ -n "$COMMITS" && "$COMMIT_COUNT" -gt 0 ]]; then
              echo "$COMMITS" | while IFS='|' read -r hash message body; do
                if [[ -n "$hash" ]]; then
                  echo "- **$message** \`$hash\`"
                fi
              done
            else
              echo "æš‚æ— æäº¤è®°å½•"
            fi
          fi
          echo "EOF"
        } >> $GITHUB_ENV
        
        # ä¿å­˜å˜é‡åˆ°ç¯å¢ƒå˜é‡
        echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
        echo "COMMIT_RANGE=$COMMIT_RANGE" >> $GITHUB_ENV
        echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV

    - name: åˆ†æå¹¶ç”ŸæˆAIå˜æ›´æ—¥å¿—
      id: generate-ai-changelog
      if: env.NEED_OPTIMIZE == 'true'
      run: |
        echo "ğŸ¤– å¼€å§‹ç”Ÿæˆç²¾ç¾çš„AIå˜æ›´æ—¥å¿—..."
        
        # åˆå§‹åŒ–AIè°ƒç”¨çŠ¶æ€
        echo "DEEPSEEK_API_SUCCESS=false" >> $GITHUB_ENV
        echo "DEEPSEEK_ERROR_MSG=" >> $GITHUB_ENV
        
        # åˆå§‹åŒ–å„ç±»åˆ«çš„æäº¤æ•°ç»„
        declare -a FEATURE_COMMITS=()
        declare -a FIX_COMMITS=()
        declare -a STYLE_COMMITS=()
        declare -a REFACTOR_COMMITS=()
        declare -a PERF_COMMITS=()
        declare -a DOCS_COMMITS=()
        declare -a BUILD_COMMITS=()
        declare -a OTHER_COMMITS=()
        
        echo "ğŸ†• å¤„ç†Gitå†å²æäº¤è®°å½•..."
        
        # ç»Ÿä¸€å¤„ç†Gitå†å²è®°å½•
        while IFS='|' read -r hash message body; do
          if [[ -n "$hash" ]]; then
            # æ¸…ç†æ¶ˆæ¯å†…å®¹
            clean_message=$(echo "$message" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
            
            # åˆ†ç±»æäº¤
            if [[ "$clean_message" =~ ^(feat|feature|æ–°å¢|æ·»åŠ ) ]]; then
              FEATURE_COMMITS+=("$hash|$clean_message")
            elif [[ "$clean_message" =~ ^(fix|bug|ä¿®å¤|è§£å†³) ]]; then
              FIX_COMMITS+=("$hash|$clean_message")
            elif [[ "$clean_message" =~ ^(style|ui|æ ·å¼|ç•Œé¢) ]]; then
              STYLE_COMMITS+=("$hash|$clean_message")
            elif [[ "$clean_message" =~ ^(refactor|é‡æ„) ]]; then
              REFACTOR_COMMITS+=("$hash|$clean_message")
            elif [[ "$clean_message" =~ ^(perf|performance|ä¼˜åŒ–|æ€§èƒ½) ]]; then
              PERF_COMMITS+=("$hash|$clean_message")
            elif [[ "$clean_message" =~ ^(docs|doc|æ–‡æ¡£) ]]; then
              DOCS_COMMITS+=("$hash|$clean_message")
            elif [[ "$clean_message" =~ ^(build|ç‰ˆæœ¬|æ„å»º) ]]; then
              BUILD_COMMITS+=("$hash|$clean_message")
            else
              OTHER_COMMITS+=("$hash|$clean_message")
            fi
          fi
        done <<< "$COMMITS_RAW"
        
        # ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
        echo "ğŸ“Š åˆæ­¥åˆ†ç±»ç»Ÿè®¡:"
        echo "  - åŠŸèƒ½æ–°å¢: ${#FEATURE_COMMITS[@]}"
        echo "  - é—®é¢˜ä¿®å¤: ${#FIX_COMMITS[@]}"
        echo "  - æ ·å¼ä¼˜åŒ–: ${#STYLE_COMMITS[@]}"
        echo "  - ä»£ç é‡æ„: ${#REFACTOR_COMMITS[@]}"
        echo "  - æ€§èƒ½ä¼˜åŒ–: ${#PERF_COMMITS[@]}"
        echo "  - æ–‡æ¡£æ›´æ–°: ${#DOCS_COMMITS[@]}"
        echo "  - æ„å»ºç›¸å…³: ${#BUILD_COMMITS[@]}"
        echo "  - å…¶ä»–æ”¹è¿›: ${#OTHER_COMMITS[@]}"
        
        # å‡†å¤‡æ‰€æœ‰æäº¤ä¿¡æ¯ç»™DeepSeek APIåˆ†æ
        ALL_COMMITS_FOR_AI=""
        for commit in "${FEATURE_COMMITS[@]}" "${FIX_COMMITS[@]}" "${STYLE_COMMITS[@]}" "${REFACTOR_COMMITS[@]}" "${PERF_COMMITS[@]}" "${DOCS_COMMITS[@]}" "${BUILD_COMMITS[@]}" "${OTHER_COMMITS[@]}"; do
          if [[ -n "$commit" ]]; then
            ALL_COMMITS_FOR_AI="$ALL_COMMITS_FOR_AI$commit\n"
          fi
        done

        echo "ğŸ§  è°ƒç”¨DeepSeek APIè¿›è¡Œæ™ºèƒ½åˆ†æå’Œä¼˜åŒ–..."
        
        # åˆ›å»ºDeepSeek APIè¯·æ±‚
        cat > deepseek_request.json << EOF
        {
          "model": "deepseek-chat",
          "messages": [
            {
              "role": "system",
              "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶å¼€å‘å˜æ›´æ—¥å¿—ç”Ÿæˆä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹Gitæäº¤è®°å½•ï¼Œå¯¹æ¯ä¸ªæäº¤è¿›è¡Œæ­£ç¡®åˆ†ç±»ï¼Œå¹¶ç”Ÿæˆä¸“ä¸šçš„å˜æ›´æ—¥å¿—ã€‚\n\nåˆ†ç±»è§„åˆ™ï¼š\n- FEATURE: æ–°åŠŸèƒ½ã€æ–°ç‰¹æ€§\n- FIX: Bugä¿®å¤ã€é—®é¢˜è§£å†³\n- STYLE: UI/UXæ”¹è¿›ã€æ ·å¼è°ƒæ•´\n- REFACTOR: ä»£ç é‡æ„ã€ç»“æ„ä¼˜åŒ–\n- PERF: æ€§èƒ½ä¼˜åŒ–\n- DOCS: æ–‡æ¡£æ›´æ–°\n- BUILD: æ„å»ºã€ç‰ˆæœ¬ã€CI/CDç›¸å…³\n- OTHER: å…¶ä»–ç±»å‹\n\nè¦æ±‚ï¼š\n1. ä¿ç•™åŸå§‹çš„Gitå“ˆå¸Œå€¼\n2. å¦‚æœåˆæ­¥åˆ†ç±»ä¸æ­£ç¡®ï¼Œè¯·çº æ­£\n3. ç”Ÿæˆç®€æ´ä¸“ä¸šçš„æè¿°\n4. æŒ‰é‡è¦æ€§æ’åº\n5. ä½¿ç”¨ä¸­æ–‡è¾“å‡º"
            },
            {
              "role": "user",
              "content": "è¯·åˆ†æä»¥ä¸‹æäº¤è®°å½•å¹¶ç”Ÿæˆä¼˜åŒ–çš„å˜æ›´æ—¥å¿—ï¼š\n\n$(echo -e "$ALL_COMMITS_FOR_AI")\n\nè¯·æŒ‰ç…§JSONæ ¼å¼è¿”å›åˆ†æç»“æœï¼š\n{\n  \"categories\": {\n    \"FEATURE\": [{\"hash\": \"commit_hash\", \"message\": \"ä¼˜åŒ–åçš„æè¿°\", \"importance\": 1-5}],\n    \"FIX\": [...],\n    \"STYLE\": [...],\n    \"REFACTOR\": [...],\n    \"PERF\": [...],\n    \"DOCS\": [...],\n    \"BUILD\": [...],\n    \"OTHER\": [...]\n  },\n  \"summary\": \"ç‰ˆæœ¬æ•´ä½“æ”¹è¿›æ‘˜è¦\",\n  \"highlights\": [\"ä¸»è¦äº®ç‚¹1\", \"ä¸»è¦äº®ç‚¹2\"]\n}"
            }
          ],
          "temperature": 0.3,
          "max_tokens": 4000
        }
        EOF

        # è°ƒç”¨DeepSeek API
        DEEPSEEK_RESPONSE=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.DEEPSEEK_API_KEY }}" \
          "https://api.deepseek.com/v1/chat/completions" \
          -d @deepseek_request.json)

        # æ£€æŸ¥APIè°ƒç”¨æ˜¯å¦æˆåŠŸ
        if [[ $(echo "$DEEPSEEK_RESPONSE" | jq -r 'has("choices")') == "true" ]]; then
          echo "âœ… DeepSeek APIè°ƒç”¨æˆåŠŸ"
          echo "DEEPSEEK_API_SUCCESS=true" >> $GITHUB_ENV
          
          # æå–AIåˆ†æç»“æœ
          AI_CONTENT=$(echo "$DEEPSEEK_RESPONSE" | jq -r '.choices[0].message.content')
          
          # å°è¯•è§£æJSONç»“æœ
          if echo "$AI_CONTENT" | jq . > /dev/null 2>&1; then
            echo "ğŸ“Š AIæ™ºèƒ½åˆ†æå®Œæˆï¼Œå¼€å§‹ç”Ÿæˆä¼˜åŒ–å˜æ›´æ—¥å¿—..."
            
            # ä¿å­˜AIåˆ†æç»“æœ
            echo "$AI_CONTENT" > ai_analysis.json
            
            # æå–æ‘˜è¦å’Œäº®ç‚¹
            AI_SUMMARY=$(echo "$AI_CONTENT" | jq -r '.summary // "AIæ™ºèƒ½åˆ†æçš„ç‰ˆæœ¬æ›´æ–°"')
            AI_HIGHLIGHTS=$(echo "$AI_CONTENT" | jq -r '.highlights[]?' 2>/dev/null || echo "")
            
            # å¼€å§‹ç”Ÿæˆä¼˜åŒ–åçš„å˜æ›´æ—¥å¿—
            AI_CHANGELOG="# ç‰ˆæœ¬ ${{ env.VERSION }} æ›´æ–°æ‘˜è¦ [AIç”Ÿæˆçš„å˜æ›´æ—¥å¿—æ‘˜è¦]

             ## ğŸ“‹ æ›´æ–°æ¦‚è§ˆ
             $AI_SUMMARY"
            
            # æ·»åŠ ä¸»è¦äº®ç‚¹
            if [[ -n "$AI_HIGHLIGHTS" ]]; then
              AI_CHANGELOG="$AI_CHANGELOG

             ### âœ¨ ä¸»è¦äº®ç‚¹"
              while IFS= read -r highlight; do
                if [[ -n "$highlight" ]]; then
                  AI_CHANGELOG="$AI_CHANGELOG
            - $highlight"
                fi
              done <<< "$AI_HIGHLIGHTS"
            fi
            
            AI_CHANGELOG="$AI_CHANGELOG

              ---"
            
            # æŒ‰ä¼˜å…ˆçº§ç”Ÿæˆå„ä¸ªåˆ†ç±»
            declare -a CATEGORIES=("FEATURE" "FIX" "PERF" "STYLE" "REFACTOR" "DOCS" "BUILD" "OTHER")
            declare -A CATEGORY_TITLES=(
              ["FEATURE"]="ğŸš€ åŠŸèƒ½æ–°å¢"
              ["FIX"]="ğŸ› é—®é¢˜ä¿®å¤"
              ["PERF"]="âš¡ æ€§èƒ½ä¼˜åŒ–"
              ["STYLE"]="ğŸ’„ æ ·å¼ä¼˜åŒ–"
              ["REFACTOR"]="â™»ï¸ ä»£ç é‡æ„"
              ["DOCS"]="ğŸ“ æ–‡æ¡£æ›´æ–°"
              ["BUILD"]="ğŸ—ï¸ æ„å»ºç›¸å…³"
              ["OTHER"]="ğŸ”§ å…¶ä»–æ”¹è¿›"
            )
            
            for category in "${CATEGORIES[@]}"; do
              # æ£€æŸ¥è¯¥åˆ†ç±»æ˜¯å¦æœ‰æäº¤
              CATEGORY_COMMITS=$(echo "$AI_CONTENT" | jq -r ".categories.$category[]?" 2>/dev/null)
              
              if [[ -n "$CATEGORY_COMMITS" ]]; then
                AI_CHANGELOG="$AI_CHANGELOG

             #### ${CATEGORY_TITLES[$category]}"
                
                # æŒ‰é‡è¦æ€§æ’åºå¹¶æ·»åŠ æäº¤
                echo "$AI_CONTENT" | jq -r ".categories.$category | sort_by(-.importance) | .[] | \"\\(.hash)|\\(.message)|\\(.importance)\"" | while IFS='|' read -r hash message importance; do
                  if [[ -n "$hash" && -n "$message" ]]; then
                    # æ ¹æ®é‡è¦æ€§æ·»åŠ ä¸åŒçš„å›¾æ ‡
                    case $importance in
                      5) icon="ğŸ”¥" ;;
                      4) icon="â­" ;;
                      3) icon="âœ¨" ;;
                      2) icon="ğŸ“Œ" ;;
                      1) icon="ğŸ“" ;;
                      *) icon="â€¢" ;;
                    esac
                    
                    AI_CHANGELOG="$AI_CHANGELOG
                   - $icon **$message**  
                     \`$hash\`"
                  fi
                done
              fi
            done
            
            echo "âœ… AIä¼˜åŒ–å˜æ›´æ—¥å¿—ç”Ÿæˆå®Œæˆ"
            
          else
            echo "âš ï¸ DeepSeek APIè¿”å›æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨åŸºç¡€åˆ†æç»“æœ"
            
            # ç”ŸæˆåŸºç¡€å˜æ›´æ—¥å¿—
            AI_CHANGELOG="# ç‰ˆæœ¬ ${{ env.VERSION }} æ›´æ–°æ‘˜è¦ [AIç”Ÿæˆçš„å˜æ›´æ—¥å¿—æ‘˜è¦]

            ## ğŸ“‹ æ›´æ–°æ¦‚è§ˆ
            åŸºäºæ™ºèƒ½åˆ†æçš„ç‰ˆæœ¬æ›´æ–°

         ---"
            
            # åŠŸèƒ½æ–°å¢éƒ¨åˆ†
            if [ ${#FEATURE_COMMITS[@]} -gt 0 ]; then
              AI_CHANGELOG="$AI_CHANGELOG

             #### ğŸš€ åŠŸèƒ½æ–°å¢"
              
              for commit in "${FEATURE_COMMITS[@]}"; do
                IFS='|' read -r hash message <<< "$commit"
                title=$(echo "$message" | sed 's/^feat[[:space:]]*:[[:space:]]*//' | sed 's/^feature[[:space:]]*:[[:space:]]*//' | sed 's/æ–°å¢[[:space:]]*//' | sed 's/æ·»åŠ [[:space:]]*//')
                AI_CHANGELOG="$AI_CHANGELOG
              - **${title}**  
                 \`$hash\`"
              done
            fi
            
            # é—®é¢˜ä¿®å¤éƒ¨åˆ†
            if [ ${#FIX_COMMITS[@]} -gt 0 ]; then
              AI_CHANGELOG="$AI_CHANGELOG

             #### ğŸ› é—®é¢˜ä¿®å¤"
              
              for commit in "${FIX_COMMITS[@]}"; do
                IFS='|' read -r hash message <<< "$commit"
                title=$(echo "$message" | sed 's/^fix[[:space:]]*:[[:space:]]*//' | sed 's/^bug[[:space:]]*:[[:space:]]*//' | sed 's/ä¿®å¤[[:space:]]*//' | sed 's/è§£å†³[[:space:]]*//')
                AI_CHANGELOG="$AI_CHANGELOG
              - **${title}**  
              \`$hash\`"
              done
            fi
            
            # å…¶ä»–åˆ†ç±»çš„å¤„ç†
            if [ ${#PERF_COMMITS[@]} -gt 0 ]; then
              AI_CHANGELOG="$AI_CHANGELOG

               #### âš¡ æ€§èƒ½ä¼˜åŒ–"
              for commit in "${PERF_COMMITS[@]}"; do
                IFS='|' read -r hash message <<< "$commit"
                AI_CHANGELOG="$AI_CHANGELOG
                 - **$(echo "$message" | sed 's/^[^:]*:[[:space:]]*//')**  
             \`$hash\`"
              done
            fi
            
            if [ ${#STYLE_COMMITS[@]} -gt 0 ]; then
              AI_CHANGELOG="$AI_CHANGELOG

             #### ğŸ’„ æ ·å¼ä¼˜åŒ–"
              for commit in "${STYLE_COMMITS[@]}"; do
                IFS='|' read -r hash message <<< "$commit"
                AI_CHANGELOG="$AI_CHANGELOG
             - **$(echo "$message" | sed 's/^[^:]*:[[:space:]]*//')**  
              \`$hash\`"
              done
            fi
            
            if [ ${#REFACTOR_COMMITS[@]} -gt 0 ]; then
              AI_CHANGELOG="$AI_CHANGELOG

            #### â™»ï¸ ä»£ç é‡æ„"
              for commit in "${REFACTOR_COMMITS[@]}"; do
                IFS='|' read -r hash message <<< "$commit"
                AI_CHANGELOG="$AI_CHANGELOG
              - **$(echo "$message" | sed 's/^[^:]*:[[:space:]]*//')**  
              \`$hash\`"
              done
            fi
            
            if [ ${#DOCS_COMMITS[@]} -gt 0 ]; then
              AI_CHANGELOG="$AI_CHANGELOG

            #### ğŸ“ æ–‡æ¡£æ›´æ–°"
              for commit in "${DOCS_COMMITS[@]}"; do
                IFS='|' read -r hash message <<< "$commit"
                AI_CHANGELOG="$AI_CHANGELOG
               - **$(echo "$message" | sed 's/^[^:]*:[[:space:]]*//')**  
                  \`$hash\`"
              done
            fi
            
            if [ ${#BUILD_COMMITS[@]} -gt 0 ]; then
              AI_CHANGELOG="$AI_CHANGELOG

              #### ğŸ—ï¸ æ„å»ºç›¸å…³"
              for commit in "${BUILD_COMMITS[@]}"; do
                IFS='|' read -r hash message <<< "$commit"
                AI_CHANGELOG="$AI_CHANGELOG
         - **$(echo "$message" | sed 's/^[^:]*:[[:space:]]*//')**  
            \`$hash\`"
              done
            fi
            
            if [ ${#OTHER_COMMITS[@]} -gt 0 ]; then
              AI_CHANGELOG="$AI_CHANGELOG

             #### ğŸ”§ å…¶ä»–æ”¹è¿›"
              for commit in "${OTHER_COMMITS[@]}"; do
                IFS='|' read -r hash message <<< "$commit"
                AI_CHANGELOG="$AI_CHANGELOG
               - **$(echo "$message" | sed 's/^[^:]*:[[:space:]]*//')**  
               \`$hash\`"
              done
            fi
          fi
          
        else
          echo "âŒ DeepSeek APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€é€»è¾‘"
          echo "é”™è¯¯ä¿¡æ¯: $(echo "$DEEPSEEK_RESPONSE" | jq -r '.error.message // "æœªçŸ¥é”™è¯¯"')"
          
          # ä½¿ç”¨åŸæœ‰é€»è¾‘ä½œä¸ºåå¤‡
          AI_CHANGELOG="# ç‰ˆæœ¬ ${{ env.VERSION }} æ›´æ–°æ‘˜è¦ [AIç”Ÿæˆçš„å˜æ›´æ—¥å¿—æ‘˜è¦]

                 ---"
          
          # åŸæœ‰çš„åŸºç¡€åˆ†æé€»è¾‘...
          if [ ${#FEATURE_COMMITS[@]} -gt 0 ]; then
            AI_CHANGELOG="$AI_CHANGELOG

                   #### ğŸš€ åŠŸèƒ½æ–°å¢"
            
            for commit in "${FEATURE_COMMITS[@]}"; do
              IFS='|' read -r hash message <<< "$commit"
              title=$(echo "$message" | sed 's/^feat[[:space:]]*:[[:space:]]*//' | sed 's/^feature[[:space:]]*:[[:space:]]*//' | sed 's/æ–°å¢[[:space:]]*//' | sed 's/æ·»åŠ [[:space:]]*//')
              AI_CHANGELOG="$AI_CHANGELOG
             - **${title}**  
               \`$hash\`"
            done
          fi
          
          if [ ${#FIX_COMMITS[@]} -gt 0 ]; then
            AI_CHANGELOG="$AI_CHANGELOG

                  #### ğŸ› é—®é¢˜ä¿®å¤"
            
            for commit in "${FIX_COMMITS[@]}"; do
              IFS='|' read -r hash message <<< "$commit"
              title=$(echo "$message" | sed 's/^fix[[:space:]]*:[[:space:]]*//' | sed 's/^bug[[:space:]]*:[[:space:]]*//' | sed 's/ä¿®å¤[[:space:]]*//' | sed 's/è§£å†³[[:space:]]*//')
              AI_CHANGELOG="$AI_CHANGELOG
             - **${title}**  
              \`$hash\`"
            done
          fi
        fi
        
        # æ·»åŠ åŸå§‹å˜æ›´è®°å½•åˆ°æŠ˜å åŒºåŸŸ
        AI_CHANGELOG="$AI_CHANGELOG

          <details>
          <summary>æŸ¥çœ‹åŸå§‹æäº¤è®°å½•</summary>

          $RAW_ORIGINAL_FOR_COLLAPSE

           </details>"
        
        # ä¿å­˜ç”Ÿæˆçš„å˜æ›´æ—¥å¿—
        echo "AI_CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$AI_CHANGELOG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "âœ… AIå˜æ›´æ—¥å¿—ç”Ÿæˆå®Œæˆ"
        echo "ğŸ“ å˜æ›´æ—¥å¿—é•¿åº¦: $(echo "$AI_CHANGELOG" | wc -c) å­—ç¬¦"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f deepseek_request.json ai_analysis.json 2>/dev/null || true

    - name: æ›´æ–°Releaseå˜æ›´æ—¥å¿—
      id: update-release-changelog
      if: env.NEED_OPTIMIZE == 'true'
      run: |
        echo "ğŸ“ æ›´æ–°Releaseå˜æ›´æ—¥å¿—..."
        
        # é‡æ–°è®¡ç®—æäº¤ç»Ÿè®¡ï¼ˆå› ä¸ºå˜é‡ä½œç”¨åŸŸé—®é¢˜ï¼‰
        FEATURE_COUNT=$(echo "$COMMITS_RAW" | grep -c "^[a-f0-9].*|.*\(feat\|feature\|æ–°å¢\|æ·»åŠ \)" || echo "0")
        FIX_COUNT=$(echo "$COMMITS_RAW" | grep -c "^[a-f0-9].*|.*\(fix\|bug\|ä¿®å¤\|è§£å†³\)" || echo "0")
        STYLE_COUNT=$(echo "$COMMITS_RAW" | grep -c "^[a-f0-9].*|.*\(style\|ui\|æ ·å¼\|ç•Œé¢\)" || echo "0")
        REFACTOR_COUNT=$(echo "$COMMITS_RAW" | grep -c "^[a-f0-9].*|.*\(refactor\|é‡æ„\)" || echo "0")
        PERF_COUNT=$(echo "$COMMITS_RAW" | grep -c "^[a-f0-9].*|.*\(perf\|performance\|ä¼˜åŒ–\|æ€§èƒ½\)" || echo "0")
        DOCS_COUNT=$(echo "$COMMITS_RAW" | grep -c "^[a-f0-9].*|.*\(docs\|doc\|æ–‡æ¡£\)" || echo "0")
        BUILD_COUNT=$(echo "$COMMITS_RAW" | grep -c "^[a-f0-9].*|.*\(build\|ç‰ˆæœ¬\|æ„å»º\)" || echo "0")
        TOTAL_COMMITS=$(echo "$COMMITS_RAW" | grep -c "^[a-f0-9]" || echo "0")
        OTHER_COUNT=$((TOTAL_COMMITS - FEATURE_COUNT - FIX_COUNT - STYLE_COUNT - REFACTOR_COUNT - PERF_COUNT - DOCS_COUNT - BUILD_COUNT))
        
        # ä½¿ç”¨GitHub APIæ›´æ–°Release
        UPDATE_RESPONSE=$(curl -s -X PATCH \
          -H "Authorization: token ${{ secrets.PAT }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases/${{ env.RELEASE_ID }}" \
          -d "{\"body\": $(echo "$AI_CHANGELOG" | jq -R -s '.')}")
        
        # æ£€æŸ¥æ›´æ–°ç»“æœ
        if [[ $(echo "$UPDATE_RESPONSE" | jq -r 'has("id")') == "true" ]]; then
          echo "âœ… Releaseå˜æ›´æ—¥å¿—æ›´æ–°æˆåŠŸ"
          echo "ğŸ”— Release URL: $(echo "$UPDATE_RESPONSE" | jq -r '.html_url')"
          echo "ai_optimized=true" >> $GITHUB_OUTPUT
          
          # è¯¦ç»†çš„ä½œä¸šæ‘˜è¦
          echo "## ğŸ¤– AIå˜æ›´æ—¥å¿—ç”Ÿæˆå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŸºæœ¬ä¿¡æ¯è¡¨æ ¼
          echo "### ğŸ“‹ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| è¿è¡Œæ¨¡å¼ | \`${{ env.RUN_MODE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬å· | \`${{ env.VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release ID | \`${{ env.RELEASE_ID }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜¯å¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆ | \`${{ env.FORCE_REGENERATE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release URL | [æŸ¥çœ‹å‘å¸ƒ]($(echo "$UPDATE_RESPONSE" | jq -r '.html_url')) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # AI APIè°ƒç”¨çŠ¶æ€
          echo "### ğŸ¤– AIåˆ†æçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| DeepSeek API | $(if [ "${{ env.DEEPSEEK_API_SUCCESS }}" == "true" ]; then echo "âœ… è°ƒç”¨æˆåŠŸ"; else echo "âŒ è°ƒç”¨å¤±è´¥"; fi) |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.DEEPSEEK_API_SUCCESS }}" != "true" ] && [ -n "${{ env.DEEPSEEK_ERROR_MSG }}" ]; then
            echo "| é”™è¯¯ä¿¡æ¯ | ${{ env.DEEPSEEK_ERROR_MSG }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| ç”Ÿæˆæ–¹å¼ | $(if [ "${{ env.DEEPSEEK_API_SUCCESS }}" == "true" ]; then echo "ğŸ§  AIæ™ºèƒ½ç”Ÿæˆ"; else echo "ğŸ“ åŸºç¡€è§„åˆ™ç”Ÿæˆ"; fi) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æäº¤ç»Ÿè®¡ä¿¡æ¯
          echo "### ğŸ“Š æäº¤ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†ç±» | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ åŠŸèƒ½æ–°å¢ | $FEATURE_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ› é—®é¢˜ä¿®å¤ | $FIX_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ’„ æ ·å¼ä¼˜åŒ– | $STYLE_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| â™»ï¸ ä»£ç é‡æ„ | $REFACTOR_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ æ€§èƒ½ä¼˜åŒ– | $PERF_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ æ–‡æ¡£æ›´æ–° | $DOCS_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ æ„å»ºç›¸å…³ | $BUILD_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ å…¶ä»–æ”¹è¿› | $OTHER_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| **æ€»è®¡** | **$TOTAL_COMMITS** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å˜æ›´æ—¥å¿—é•¿åº¦å¯¹æ¯”
          ORIGINAL_LENGTH=$(echo "$ORIGINAL_CHANGELOG" | wc -c)
          AI_LENGTH=$(echo "$AI_CHANGELOG" | wc -c)
          echo "### ğŸ“ å˜æ›´æ—¥å¿—ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å­—ç¬¦æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| åŸå§‹å˜æ›´æ—¥å¿— | $ORIGINAL_LENGTH |" >> $GITHUB_STEP_SUMMARY
          echo "| AIä¼˜åŒ–å | $AI_LENGTH |" >> $GITHUB_STEP_SUMMARY
          if [ $ORIGINAL_LENGTH -gt 0 ]; then
            echo "| å¢é•¿ç‡ | $(( (AI_LENGTH - ORIGINAL_LENGTH) * 100 / ORIGINAL_LENGTH ))% |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| å¢é•¿ç‡ | N/Aï¼ˆåŸå§‹ä¸ºç©ºï¼‰ |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å¦‚æœAIåˆ†æç»“æœå­˜åœ¨ï¼Œæ˜¾ç¤ºAIåˆ†æçš„äº®ç‚¹
          if [[ -f "ai_analysis.json" ]]; then
            AI_HIGHLIGHTS=$(cat ai_analysis.json | jq -r '.highlights[]?' 2>/dev/null || echo "")
            if [[ -n "$AI_HIGHLIGHTS" ]]; then
              echo "### âœ¨ AIè¯†åˆ«çš„ä¸»è¦äº®ç‚¹" >> $GITHUB_STEP_SUMMARY
              while IFS= read -r highlight; do
                if [[ -n "$highlight" ]]; then
                  echo "- $highlight" >> $GITHUB_STEP_SUMMARY
                fi
              done <<< "$AI_HIGHLIGHTS"
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            AI_SUMMARY=$(cat ai_analysis.json | jq -r '.summary // ""' 2>/dev/null)
            if [[ -n "$AI_SUMMARY" && "$AI_SUMMARY" != "null" ]]; then
              echo "### ğŸ§  AIç”Ÿæˆçš„ç‰ˆæœ¬æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
              echo "> $AI_SUMMARY" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # æ˜¾ç¤ºå¤„ç†çš„æäº¤èŒƒå›´
          echo "### ğŸ¯ å¤„ç†èŒƒå›´" >> $GITHUB_STEP_SUMMARY
          echo "- **å½“å‰ç‰ˆæœ¬**: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ env.LAST_TAG }}" ]]; then
            echo "- **ä¸Šä¸€ç‰ˆæœ¬**: ${{ env.LAST_TAG }}" >> $GITHUB_STEP_SUMMARY
            echo "- **æäº¤èŒƒå›´**: ${{ env.COMMIT_RANGE }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **æäº¤èŒƒå›´**: ä»é¦–æ¬¡æäº¤åˆ°å½“å‰ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **å¤„ç†çš„æäº¤æ•°**: ${{ env.COMMIT_COUNT }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è¿è¡Œæ—¶é—´ä¿¡æ¯
          echo "### â±ï¸ æ‰§è¡Œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµ**: [\`${{ github.workflow }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤SHA**: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          
          # æˆåŠŸçŠ¶æ€
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **çŠ¶æ€**: AIå˜æ›´æ—¥å¿—ç”Ÿæˆå¹¶æ›´æ–°æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          
        else
          echo "âŒ Releaseå˜æ›´æ—¥å¿—æ›´æ–°å¤±è´¥"
          echo "é”™è¯¯ä¿¡æ¯: $(echo "$UPDATE_RESPONSE" | jq -r '.message // "æœªçŸ¥é”™è¯¯"')"
          echo "ai_optimized=false" >> $GITHUB_OUTPUT
          
          # å¤±è´¥æ—¶çš„æ‘˜è¦
          echo "## âŒ AIå˜æ›´æ—¥å¿—ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "é”™è¯¯è¯¦æƒ…: $(echo "$UPDATE_RESPONSE" | jq -r '.message // "æœªçŸ¥é”™è¯¯"')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release ID**: ${{ env.RELEASE_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ¨¡å¼**: ${{ env.RUN_MODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          exit 1
        fi

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        find . -name "*.tmp" -delete 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"