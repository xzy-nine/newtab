name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡ç‰ˆæœ¬æˆ–æ ‡ç­¾ï¼ˆå¦‚ï¼šv1.0.0ã€latest æˆ– allï¼‰'
        required: true
        type: string
        default: 'latest'
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        type: string
      release-id:
        description: 'Release ID'
        required: true
        type: string
    outputs:
      ai_optimized:
        description: "æ˜¯å¦å®ŒæˆAIä¼˜åŒ–"
        value: ${{ jobs.ai-changelog-generation.outputs.ai_optimized }}
      ai_success:
        description: "AIæ˜¯å¦æˆåŠŸè°ƒç”¨"
        value: ${{ jobs.ai-changelog-generation.outputs.ai_success }}
      total_commits:
        description: "å¤„ç†çš„æäº¤æ€»æ•°"
        value: ${{ jobs.ai-changelog-generation.outputs.total_commits }}
      processed_releases:
        description: "å¤„ç†çš„å‘å¸ƒæ•°é‡"
        value: ${{ jobs.ai-changelog-generation.outputs.processed_releases }}

jobs:
  ai-changelog-generation:
    name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      ai_optimized: ${{ steps.run-generator.outputs.ai_optimized }}
      ai_success: ${{ steps.run-generator.outputs.ai_success }}
      total_commits: ${{ steps.run-generator.outputs.total_commits }}
      generation_mode: ${{ steps.run-generator.outputs.generation_mode }}
      processed_releases: ${{ steps.run-generator.outputs.processed_releases }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: åˆå§‹åŒ–æ‘˜è¦
      run: |
        echo "# ðŸ¤– AIå˜æ›´æ—¥å¿—ç”Ÿæˆ - æ‰§è¡Œä¸­" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ æ‰§è¡Œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        
        # æ‰§è¡Œæ¨¡å¼ä¿¡æ¯
        if [ "${{ github.event_name }}" = "workflow_call" ]; then
          echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ¤– è‡ªåŠ¨è§¦å‘ (workflow_call) |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘ç‰ˆæœ¬ | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release ID | \`${{ inputs.release-id }}\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ“ æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) |" >> $GITHUB_STEP_SUMMARY
          echo "| ç›®æ ‡å‚æ•° | \`${{ inputs.target }}\` |" >> $GITHUB_STEP_SUMMARY
          
          # æ ¹æ®ç›®æ ‡ç±»åž‹æ·»åŠ è¯´æ˜Ž
          if [ "${{ inputs.target }}" = "all" ]; then
            echo "| å¤„ç†ç±»åž‹ | ðŸ”„ æ‰¹é‡å¤„ç†æ‰€æœ‰Release |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.target }}" = "latest" ]; then
            echo "| å¤„ç†ç±»åž‹ | ðŸŽ¯ å¤„ç†æœ€æ–°Release |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| å¤„ç†ç±»åž‹ | ðŸŽ¯ å¤„ç†æŒ‡å®šç‰ˆæœ¬ |" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "| å¼€å§‹æ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
        echo "| å½“å‰çŠ¶æ€ | â³ åˆå§‹åŒ–ä¸­... |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š æ‰§è¡Œè¿›åº¦" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä»£ç æ£€å‡ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- â³ å‡†å¤‡PythonçŽ¯å¢ƒ..." >> $GITHUB_STEP_SUMMARY

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: æ›´æ–°çŽ¯å¢ƒå‡†å¤‡æ‘˜è¦
      run: |
        # æ›´æ–°æ‘˜è¦ - çŽ¯å¢ƒå‡†å¤‡
        {
          echo "# ðŸ¤– AIå˜æ›´æ—¥å¿—ç”Ÿæˆ - æ‰§è¡Œä¸­"
          echo ""
          echo "## ðŸ“‹ æ‰§è¡Œä¿¡æ¯"
          echo "| é¡¹ç›® | çŠ¶æ€ |"
          echo "|------|------|"
          
          # æ‰§è¡Œæ¨¡å¼ä¿¡æ¯
          if [ "${{ github.event_name }}" = "workflow_call" ]; then
            echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ¤– è‡ªåŠ¨è§¦å‘ (workflow_call) |"
            echo "| è§¦å‘ç‰ˆæœ¬ | \`${{ inputs.version }}\` |"
            echo "| Release ID | \`${{ inputs.release-id }}\` |"
          else
            echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ“ æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) |"
            echo "| ç›®æ ‡å‚æ•° | \`${{ inputs.target }}\` |"
            
            if [ "${{ inputs.target }}" = "all" ]; then
              echo "| å¤„ç†ç±»åž‹ | ðŸ”„ æ‰¹é‡å¤„ç†æ‰€æœ‰Release |"
            elif [ "${{ inputs.target }}" = "latest" ]; then
              echo "| å¤„ç†ç±»åž‹ | ðŸŽ¯ å¤„ç†æœ€æ–°Release |"
            else
              echo "| å¤„ç†ç±»åž‹ | ðŸŽ¯ å¤„ç†æŒ‡å®šç‰ˆæœ¬ |"
            fi
          fi
          
          echo "| å¼€å§‹æ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S') |"
          echo "| å½“å‰çŠ¶æ€ | â³ çŽ¯å¢ƒå‡†å¤‡ä¸­... |"
          echo ""
          echo "## ðŸ“Š æ‰§è¡Œè¿›åº¦"
          echo "- âœ… ä»£ç æ£€å‡ºå®Œæˆ"
          echo "- âœ… PythonçŽ¯å¢ƒè®¾ç½®å®Œæˆ"
          echo "- â³ å®‰è£…ä¾èµ–åŒ…..."
        } > $GITHUB_STEP_SUMMARY

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        pip install -r .github/workflows/ai-log-work-py/requirements.txt

    - name: æ›´æ–°ä¾èµ–å®‰è£…æ‘˜è¦
      run: |
        # æ›´æ–°æ‘˜è¦ - ä¾èµ–å®‰è£…
        {
          echo "# ðŸ¤– AIå˜æ›´æ—¥å¿—ç”Ÿæˆ - æ‰§è¡Œä¸­"
          echo ""
          echo "## ðŸ“‹ æ‰§è¡Œä¿¡æ¯"
          echo "| é¡¹ç›® | çŠ¶æ€ |"
          echo "|------|------|"
          
          # æ‰§è¡Œæ¨¡å¼ä¿¡æ¯
          if [ "${{ github.event_name }}" = "workflow_call" ]; then
            echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ¤– è‡ªåŠ¨è§¦å‘ (workflow_call) |"
            echo "| è§¦å‘ç‰ˆæœ¬ | \`${{ inputs.version }}\` |"
            echo "| Release ID | \`${{ inputs.release-id }}\` |"
          else
            echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ“ æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) |"
            echo "| ç›®æ ‡å‚æ•° | \`${{ inputs.target }}\` |"
            
            if [ "${{ inputs.target }}" = "all" ]; then
              echo "| å¤„ç†ç±»åž‹ | ðŸ”„ æ‰¹é‡å¤„ç†æ‰€æœ‰Release |"
            elif [ "${{ inputs.target }}" = "latest" ]; then
              echo "| å¤„ç†ç±»åž‹ | ðŸŽ¯ å¤„ç†æœ€æ–°Release |"
            else
              echo "| å¤„ç†ç±»åž‹ | ðŸŽ¯ å¤„ç†æŒ‡å®šç‰ˆæœ¬ |"
            fi
          fi
          
          echo "| å¼€å§‹æ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S') |"
          echo "| å½“å‰çŠ¶æ€ | ðŸš€ å¼€å§‹ç”Ÿæˆå˜æ›´æ—¥å¿—... |"
          echo ""
          echo "## ðŸ“Š æ‰§è¡Œè¿›åº¦"
          echo "- âœ… ä»£ç æ£€å‡ºå®Œæˆ"
          echo "- âœ… PythonçŽ¯å¢ƒè®¾ç½®å®Œæˆ"
          echo "- âœ… ä¾èµ–åŒ…å®‰è£…å®Œæˆ"
          echo "- ðŸš€ æ­£åœ¨æ‰§è¡ŒAIå˜æ›´æ—¥å¿—ç”Ÿæˆ..."
        } > $GITHUB_STEP_SUMMARY

    - name: è¿è¡ŒAIå˜æ›´æ—¥å¿—ç”Ÿæˆå™¨
      id: run-generator
      run: |
        cd .github/workflows/ai-log-work-py
        
        echo "ðŸš€ å¼€å§‹æ‰§è¡ŒAIå˜æ›´æ—¥å¿—ç”Ÿæˆ..."
        echo "==========================================â€‹============================="
        
        # æ ¹æ®è§¦å‘æ–¹å¼è®¾ç½®å‚æ•°
        if [ "${{ github.event_name }}" = "workflow_call" ]; then
          # è‡ªåŠ¨è§¦å‘æ¨¡å¼
          echo "ðŸ¤– æ‰§è¡Œæ¨¡å¼: è‡ªåŠ¨è§¦å‘ (workflow_call)"
          echo "ðŸ“‹ ç‰ˆæœ¬å·: ${{ inputs.version }}"
          echo "ðŸ·ï¸ Release ID: ${{ inputs.release-id }}"
          echo "============================================â€‹========================="
            python changelog.py \
            --version "${{ inputs.version }}" \
            --release-id "${{ inputs.release-id }}" \
            --event-name "workflow_call" \
            --repo "${{ github.repository }}" \
            --github-token "${{ secrets.PAT }}" \
            --deepseek-api-key "${{ secrets.DEEPSEEK_API_KEY }}"
        else
          # æ‰‹åŠ¨è§¦å‘æ¨¡å¼
          echo "ðŸ“ æ‰§è¡Œæ¨¡å¼: æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)"
          echo "ðŸŽ¯ ç›®æ ‡å‚æ•°: ${{ inputs.target }}"
          
          # æ ¹æ®ç›®æ ‡ç±»åž‹è¾“å‡ºä¸åŒæç¤º
          if [ "${{ inputs.target }}" = "all" ]; then
            echo "ðŸ”„ æ‰¹é‡å¤„ç†æ¨¡å¼ï¼šå°†å¤„ç†æ‰€æœ‰Release"
            echo "â±ï¸ é¢„è®¡éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
            echo "ðŸ“Š å®žæ—¶è¿›åº¦å°†åœ¨ä¸‹æ–¹æ˜¾ç¤º"
          elif [ "${{ inputs.target }}" = "latest" ]; then
            echo "ðŸŽ¯ å•ä¸ªå¤„ç†æ¨¡å¼ï¼šå¤„ç†æœ€æ–°Release"
          else
            echo "ðŸŽ¯ å•ä¸ªå¤„ç†æ¨¡å¼ï¼šå¤„ç†æŒ‡å®šç‰ˆæœ¬ ${{ inputs.target }}"
          fi
          
          echo "============================================â€‹========================="
            python changelog.py \
            --target "${{ inputs.target }}" \
            --event-name "workflow_dispatch" \
            --repo "${{ github.repository }}" \
            --github-token "${{ secrets.PAT }}" \
            --deepseek-api-key "${{ secrets.DEEPSEEK_API_KEY }}"
        fi
        
        # æ•èŽ·é€€å‡ºç 
        exit_code=$?
        
        echo ""
        echo "============================================â€‹========================="
        
        # è®¾ç½®è¾“å‡ºå˜é‡å’Œæœ€ç»ˆçŠ¶æ€
        if [ $exit_code -eq 0 ]; then
          echo "ai_optimized=true" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ AIå˜æ›´æ—¥å¿—ç”Ÿæˆæµç¨‹å®Œæˆ!"
          echo "âœ… çŠ¶æ€: æˆåŠŸ"
        else
          echo "ai_optimized=false" >> $GITHUB_OUTPUT
          echo "ðŸ’¥ AIå˜æ›´æ—¥å¿—ç”Ÿæˆæµç¨‹å¤±è´¥!"
          echo "âŒ çŠ¶æ€: å¤±è´¥ (é€€å‡ºç : $exit_code)"
        fi
        
        echo "============================================â€‹========================="
        
        exit $exit_code

    - name: æ›´æ–°æœ€ç»ˆæ‰§è¡Œæ‘˜è¦
      if: always()
      run: |
        # èŽ·å–å½“å‰æ—¶é—´
        current_time=$(date '+%Y-%m-%d %H:%M:%S')
        
        # ç”Ÿæˆæœ€ç»ˆæ‘˜è¦
        {
          echo "# ðŸŽ¯ AIå˜æ›´æ—¥å¿—ç”Ÿæˆ - æ‰§è¡Œå®Œæˆ"
          echo ""
          echo "## ðŸ“‹ æ‰§è¡Œç»“æžœ"
          echo "| é¡¹ç›® | ç»“æžœ |"
          echo "|------|------|"
          
          # æ‰§è¡Œæ¨¡å¼ä¿¡æ¯
          if [ "${{ github.event_name }}" = "workflow_call" ]; then
            echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ¤– è‡ªåŠ¨è§¦å‘ (workflow_call) |"
            echo "| è§¦å‘ç‰ˆæœ¬ | \`${{ inputs.version }}\` |"
            echo "| Release ID | \`${{ inputs.release-id }}\` |"
          else
            echo "| æ‰§è¡Œæ¨¡å¼ | ðŸ“ æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) |"
            echo "| ç›®æ ‡å‚æ•° | \`${{ inputs.target }}\` |"
            
            # æ ¹æ®ç›®æ ‡ç±»åž‹æ·»åŠ è¯´æ˜Ž
            if [ "${{ inputs.target }}" = "all" ]; then
              echo "| å¤„ç†ç±»åž‹ | ðŸ”„ æ‰¹é‡å¤„ç†æ‰€æœ‰Release |"
            elif [ "${{ inputs.target }}" = "latest" ]; then
              echo "| å¤„ç†ç±»åž‹ | ðŸŽ¯ å¤„ç†æœ€æ–°Release |"
            else
              echo "| å¤„ç†ç±»åž‹ | ðŸŽ¯ å¤„ç†æŒ‡å®šç‰ˆæœ¬ |"
            fi
          fi
          
          # æ‰§è¡Œç»“æžœ
          echo "| æ‰§è¡ŒçŠ¶æ€ | ${{ steps.run-generator.outcome == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |"
          echo "| AIä¼˜åŒ–çŠ¶æ€ | ${{ steps.run-generator.outputs.ai_optimized == 'true' && 'âœ… å·²å®Œæˆ' || 'âŒ æœªå®Œæˆ' }} |"
          
          # AIè°ƒç”¨ç»“æžœ
          if [ "${{ steps.run-generator.outputs.ai_success }}" = "true" ]; then
            echo "| AIç”Ÿæˆæ–¹å¼ | ðŸ§  AIæ™ºèƒ½ç”Ÿæˆ |"
          else
            echo "| AIç”Ÿæˆæ–¹å¼ | ðŸ“ åŸºç¡€è§„åˆ™ç”Ÿæˆ |"
          fi
          
          # ç»Ÿè®¡ä¿¡æ¯
          if [ "${{ steps.run-generator.outputs.total_commits }}" != "" ]; then
            echo "| å¤„ç†æäº¤æ•° | ${{ steps.run-generator.outputs.total_commits }} ä¸ª |"
          fi
          
          if [ "${{ steps.run-generator.outputs.processed_releases }}" != "" ]; then
            echo "| å¤„ç†å‘å¸ƒæ•° | ${{ steps.run-generator.outputs.processed_releases }} ä¸ª |"
          fi
          
          # æ‰§è¡Œæ—¶é—´
          echo "| å®Œæˆæ—¶é—´ | $current_time |"
          echo ""
          
          # æ ¹æ®ç»“æžœæ·»åŠ ä¸åŒçš„è¯´æ˜Ž
          if [ "${{ steps.run-generator.outcome }}" = "success" ]; then
            echo "## âœ… æ‰§è¡ŒæˆåŠŸ"
            echo ""
            echo "å˜æ›´æ—¥å¿—å·²æˆåŠŸç”Ÿæˆå¹¶æ›´æ–°åˆ°å¯¹åº”çš„Releaseé¡µé¢ã€‚"
            echo ""
            
            if [ "${{ steps.run-generator.outputs.ai_success }}" = "true" ]; then
              echo "ðŸ§  **AIæ™ºèƒ½åˆ†æž**: ä½¿ç”¨DeepSeek APIæˆåŠŸåˆ†æžæäº¤è®°å½•ï¼Œç”Ÿæˆäº†æ™ºèƒ½åŒ–çš„å˜æ›´æ—¥å¿—ã€‚"
            else
              echo "ðŸ“ **åŸºç¡€è§„åˆ™ç”Ÿæˆ**: AIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€è§„åˆ™ç”Ÿæˆäº†å˜æ›´æ—¥å¿—ã€‚"
            fi
            
            echo ""
            echo "### ðŸ”— ç›¸å…³é“¾æŽ¥"
            echo "- æ£€æŸ¥æ›´æ–°çš„Releaseé¡µé¢ç¡®è®¤å˜æ›´æ—¥å¿—"
            echo "- å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œæ—¥å¿—"
            
          else
            echo "## âŒ æ‰§è¡Œå¤±è´¥"
            echo ""
            echo "å˜æ›´æ—¥å¿—ç”Ÿæˆè¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‰§è¡Œæ—¥å¿—èŽ·å–è¯¦ç»†ä¿¡æ¯ã€‚"
            echo ""
            echo "### ðŸ” æ•…éšœæŽ’æŸ¥"
            echo "1. æ£€æŸ¥GitHub Tokenæƒé™"
            echo "2. æ£€æŸ¥DeepSeek API Keyé…ç½®"
            echo "3. æ£€æŸ¥ç›®æ ‡ç‰ˆæœ¬æ˜¯å¦å­˜åœ¨"
            echo "4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—"
          fi
          
          echo ""
          echo "---"
          echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ @ $current_time*"
          
        } > $GITHUB_STEP_SUMMARY

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        find . -name "*.tmp" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
