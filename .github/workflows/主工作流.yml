name: 主工作流
on:
  push:
    branches:
      - main

jobs:
  version-check-and-build:
    name: 版本检查与构建
    uses: ./.github/workflows/版本检查与构建.yml
    secrets: inherit

  release-management:
    name: 发布管理
    needs: version-check-and-build
    # 明确条件：只有在新版本且标签不存在时才执行
    if: |
      needs.version-check-and-build.outputs.is_new_version == 'true' && 
      needs.version-check-and-build.outputs.tag_exists == 'false'
    uses: ./.github/workflows/发布管理.yml
    with:
      version: ${{ needs.version-check-and-build.outputs.version }}
      changelog: ${{ needs.version-check-and-build.outputs.changelog }}
      build-path: ${{ needs.version-check-and-build.outputs.build_path }}
    secrets: inherit

  ai-changelog-generation:
    name: AI变更日志生成
    needs: [version-check-and-build, release-management]
    # 修复条件判断 - 只有在发布成功时才执行
    if: |
      needs.version-check-and-build.outputs.is_new_version == 'true' && 
      needs.version-check-and-build.outputs.tag_exists == 'false' &&
      needs.release-management.result == 'success'
    uses: ./.github/workflows/AI变更日志生成.yml
    with:
      version: ${{ needs.version-check-and-build.outputs.version }}
      release-id: ${{ needs.release-management.outputs.release-id }}
    secrets: inherit

  workflow-summary:
    name: 工作流总结
    runs-on: ubuntu-latest
    needs: [version-check-and-build, release-management, ai-changelog-generation]
    if: always()
    steps:
    - name: 生成工作流执行总结
      run: |
        echo "## 🚀 主工作流执行总结" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 执行状态" >> $GITHUB_STEP_SUMMARY
        echo "| 作业 | 状态 | 结果 |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| 版本检查与构建 | ${{ needs.version-check-and-build.result }} | ${{ needs.version-check-and-build.result == 'success' && '✅ 成功' || '❌ 失败' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| 发布管理 | ${{ needs.release-management.result }} | ${{ needs.release-management.result == 'success' && '✅ 成功' || needs.release-management.result == 'skipped' && '⏭️ 跳过' || '❌ 失败' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AI变更日志生成 | ${{ needs.ai-changelog-generation.result }} | ${{ needs.ai-changelog-generation.result == 'success' && '✅ 成功' || needs.ai-changelog-generation.result == 'skipped' && '⏭️ 跳过' || '❌ 失败' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.version-check-and-build.outputs.is_new_version }}" == "true" ]; then
          echo "### 📦 版本信息" >> $GITHUB_STEP_SUMMARY
          echo "| 项目 | 值 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| 当前版本 | \`${{ needs.version-check-and-build.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 是否新版本 | ${{ needs.version-check-and-build.outputs.is_new_version == 'true' && '✅ 是' || '❌ 否' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 标签是否存在 | ${{ needs.version-check-and-build.outputs.tag_exists == 'true' && '⚠️ 已存在' || '✅ 不存在' }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.release-management.result }}" == "success" ]; then
            echo "| Release ID | \`${{ needs.release-management.outputs.release-id }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Release URL | [${{ needs.release-management.outputs.release-url }}](${{ needs.release-management.outputs.release-url }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### 🎯 执行结果" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.version-check-and-build.outputs.is_new_version }}" == "true" ] && [ "${{ needs.version-check-and-build.outputs.tag_exists }}" == "false" ]; then
          if [ "${{ needs.release-management.result }}" == "success" ]; then
            echo "🎉 **发布成功！**" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ 版本检查通过" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ 构建包创建成功" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Release发布成功" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.ai-changelog-generation.result }}" == "success" ]; then
              echo "- ✅ AI变更日志生成成功" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⚠️ AI变更日志生成失败或跳过" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ **发布失败！**" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ 版本检查通过" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ 构建包创建成功" >> $GITHUB_STEP_SUMMARY
            echo "- ❌ Release发布失败" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "ℹ️ **无需发布**" >> $GITHUB_STEP_SUMMARY
          echo "- 版本未更新或标签已存在" >> $GITHUB_STEP_SUMMARY
        fi
