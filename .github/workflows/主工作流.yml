name: ä¸»å·¥ä½œæµ
on:
  push:
    branches:
      - main

# å®Œæ•´çš„æƒé™è®¾ç½®
permissions:
  contents: write          # åˆ›å»º Release å’Œæ ‡ç­¾
  actions: read           # è¯»å–å·¥ä½œæµçŠ¶æ€
  packages: write         # ä¸Šä¼ åŒ…ï¼ˆå¦‚æœéœ€è¦ï¼‰
  pull-requests: write    # æ›´æ–° PRï¼ˆå¦‚æœéœ€è¦ï¼‰
  issues: write          # åˆ›å»º Issueï¼ˆå¦‚æœéœ€è¦ï¼‰
  repository-projects: read  # è¯»å–é¡¹ç›®ä¿¡æ¯
  id-token: write        # OIDC tokenï¼ˆå¦‚æœä½¿ç”¨ï¼‰

jobs:
  version-check-and-build:
    name: ç‰ˆæœ¬æ£€æŸ¥ä¸æ„å»º
    uses: ./.github/workflows/ç‰ˆæœ¬æ£€æŸ¥ä¸æ„å»º.yml
    secrets: inherit
    # æ˜ç¡®ä¼ é€’æƒé™
    permissions:
      contents: read
      actions: read

  release-management:
    name: å‘å¸ƒç®¡ç†
    needs: version-check-and-build
    if: |
      needs.version-check-and-build.outputs.is_new_version == 'true' && 
      needs.version-check-and-build.outputs.tag_exists == 'false' &&
      needs.version-check-and-build.result == 'success'
    uses: ./.github/workflows/å‘å¸ƒç®¡ç†.yml
    with:
      version: ${{ needs.version-check-and-build.outputs.version }}
      changelog: ${{ needs.version-check-and-build.outputs.changelog }}
      build-path: ${{ needs.version-check-and-build.outputs.build_path }}
    secrets: inherit
    permissions:
      contents: write
      actions: read

  ai-changelog-generation:
    name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
    needs: [version-check-and-build, release-management]
    if: |
      needs.version-check-and-build.outputs.is_new_version == 'true' && 
      needs.version-check-and-build.outputs.tag_exists == 'false' &&
      needs.release-management.result == 'success'
    uses: ./.github/workflows/AIå˜æ›´æ—¥å¿—ç”Ÿæˆ.yml
    with:
      version: ${{ needs.version-check-and-build.outputs.version }}
      release-id: ${{ needs.release-management.outputs.release-id }}
    secrets: inherit
    permissions:
      contents: write
      actions: read

  workflow-summary:
    name: å·¥ä½œæµæ€»ç»“
    runs-on: ubuntu-latest
    needs: [version-check-and-build, release-management, ai-changelog-generation]
    if: always()
    steps:
    - name: ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œæ€»ç»“
      run: |
        echo "## ğŸš€ ä¸»å·¥ä½œæµæ‰§è¡Œæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "| ä½œä¸š | çŠ¶æ€ |,ç»“æœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ç‰ˆæœ¬æ£€æŸ¥ä¸æ„å»º | ${{ needs.version-check-and-build.result }} | ${{ needs.version-check-and-build.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å‘å¸ƒç®¡ç† | ${{ needs.release-management.result }} | ${{ needs.release-management.result == 'success' && 'âœ… æˆåŠŸ' || needs.release-management.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AIå˜æ›´æ—¥å¿—ç”Ÿæˆ | ${{ needs.ai-changelog-generation.result }} | ${{ needs.ai-changelog-generation.result == 'success' && 'âœ… æˆåŠŸ' || needs.ai-changelog-generation.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.version-check-and-build.outputs.is_new_version }}" == "true" ]; then
          echo "### ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| å½“å‰ç‰ˆæœ¬ | \`${{ needs.version-check-and-build.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜¯å¦æ–°ç‰ˆæœ¬ | ${{ needs.version-check-and-build.outputs.is_new_version == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ ‡ç­¾æ˜¯å¦å­˜åœ¨ | ${{ needs.version-check-and-build.outputs.tag_exists == 'true' && 'âš ï¸ å·²å­˜åœ¨' || 'âœ… ä¸å­˜åœ¨' }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.release-management.result }}" == "success" ]; then
            echo "| Release ID | \`${{ needs.release-management.outputs.release-id }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Release URL | [${{ needs.release-management.outputs.release-url }}](${{ needs.release-management.outputs.release-url }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ğŸ¯ æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.version-check-and-build.outputs.is_new_version }}" == "true" ] && [ "${{ needs.version-check-and-build.outputs.tag_exists }}" == "false" ]; then
          if [ "${{ needs.release-management.result }}" == "success" ]; then
            echo "ğŸ‰ **å‘å¸ƒæˆåŠŸï¼**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æ„å»ºåŒ…åˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Releaseå‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.ai-changelog-generation.result }}" == "success" ]; then
              echo "- âœ… AIå˜æ›´æ—¥å¿—ç”ŸæˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸ AIå˜æ›´æ—¥å¿—ç”Ÿæˆå¤±è´¥æˆ–è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **å‘å¸ƒå¤±è´¥ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æ„å»ºåŒ…åˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Releaseå‘å¸ƒå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â„¹ï¸ **æ— éœ€å‘å¸ƒ**" >> $GITHUB_STEP_SUMMARY
          echo "- ç‰ˆæœ¬æœªæ›´æ–°æˆ–æ ‡ç­¾å·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi

  debug-outputs:
    name: è°ƒè¯•è¾“å‡º
    needs: version-check-and-build
    runs-on: ubuntu-latest
    steps:
    - name: è¾“å‡ºè°ƒè¯•ä¿¡æ¯
      run: |
        echo "ç‰ˆæœ¬æ£€æŸ¥ç»“æœ:"
        echo "- version: ${{ needs.version-check-and-build.outputs.version }}"
        echo "- is_new_version: ${{ needs.version-check-and-build.outputs.is_new_version }}"
        echo "- tag_exists: ${{ needs.version-check-and-build.outputs.tag_exists }}"
        echo "- result: ${{ needs.version-check-and-build.result }}"
        echo "- build_path: ${{ needs.version-check-and-build.outputs.build_path }}"
        echo "- changelog length: $(echo '${{ needs.version-check-and-build.outputs.changelog }}' | wc -c)"
        echo ""
        echo "æ¡ä»¶åˆ¤æ–­:"
        echo "- is_new_version == 'true': ${{ needs.version-check-and-build.outputs.is_new_version == 'true' }}"
        echo "- tag_exists == 'false': ${{ needs.version-check-and-build.outputs.tag_exists == 'false' }}"
        echo "- result == 'success': ${{ needs.version-check-and-build.result == 'success' }}"
        echo ""
        echo "å®Œæ•´æ¡ä»¶: ${{ needs.version-check-and-build.outputs.is_new_version == 'true' && needs.version-check-and-build.outputs.tag_exists == 'false' && needs.version-check-and-build.result == 'success' }}"
