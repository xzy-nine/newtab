name: ä¸»å·¥ä½œæµ
on:
  push:
    branches:
      - main

jobs:
  version-check-and-build:
    name: ç‰ˆæœ¬æ£€æŸ¥ä¸Žæž„å»º
    uses: ./.github/workflows/ç‰ˆæœ¬æ£€æŸ¥ä¸Žæž„å»º.yml
    secrets: inherit

  release-management:
    name: å‘å¸ƒç®¡ç†
    needs: version-check-and-build
    # æ˜Žç¡®æ¡ä»¶ï¼šåªæœ‰åœ¨æ–°ç‰ˆæœ¬ä¸”æ ‡ç­¾ä¸å­˜åœ¨æ—¶æ‰æ‰§è¡Œ
    if: |
      needs.version-check-and-build.outputs.is_new_version == 'true' && 
      needs.version-check-and-build.outputs.tag_exists == 'false'
    uses: ./.github/workflows/å‘å¸ƒç®¡ç†.yml
    with:
      version: ${{ needs.version-check-and-build.outputs.version }}
      changelog: ${{ needs.version-check-and-build.outputs.changelog }}
      build-path: ${{ needs.version-check-and-build.outputs.build_path }}
    secrets: inherit

  ai-changelog-generation:
    name: AIå˜æ›´æ—¥å¿—ç”Ÿæˆ
    needs: [version-check-and-build, release-management]
    # ä¿®å¤æ¡ä»¶åˆ¤æ–­ - åªæœ‰åœ¨å‘å¸ƒæˆåŠŸæ—¶æ‰æ‰§è¡Œ
    if: |
      needs.version-check-and-build.outputs.is_new_version == 'true' && 
      needs.version-check-and-build.outputs.tag_exists == 'false' &&
      needs.release-management.result == 'success'
    uses: ./.github/workflows/AIå˜æ›´æ—¥å¿—ç”Ÿæˆ.yml
    with:
      version: ${{ needs.version-check-and-build.outputs.version }}
      release-id: ${{ needs.release-management.outputs.release-id }}
    secrets: inherit

  workflow-summary:
    name: å·¥ä½œæµæ€»ç»“
    runs-on: ubuntu-latest
    needs: [version-check-and-build, release-management, ai-changelog-generation]
    if: always()
    steps:
    - name: ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œæ€»ç»“
      run: |
        echo "## ðŸš€ ä¸»å·¥ä½œæµæ‰§è¡Œæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "| ä½œä¸š | çŠ¶æ€ | ç»“æžœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ç‰ˆæœ¬æ£€æŸ¥ä¸Žæž„å»º | ${{ needs.version-check-and-build.result }} | ${{ needs.version-check-and-build.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å‘å¸ƒç®¡ç† | ${{ needs.release-management.result }} | ${{ needs.release-management.result == 'success' && 'âœ… æˆåŠŸ' || needs.release-management.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AIå˜æ›´æ—¥å¿—ç”Ÿæˆ | ${{ needs.ai-changelog-generation.result }} | ${{ needs.ai-changelog-generation.result == 'success' && 'âœ… æˆåŠŸ' || needs.ai-changelog-generation.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.version-check-and-build.outputs.is_new_version }}" == "true" ]; then
          echo "### ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| å½“å‰ç‰ˆæœ¬ | \`${{ needs.version-check-and-build.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜¯å¦æ–°ç‰ˆæœ¬ | ${{ needs.version-check-and-build.outputs.is_new_version == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ ‡ç­¾æ˜¯å¦å­˜åœ¨ | ${{ needs.version-check-and-build.outputs.tag_exists == 'true' && 'âš ï¸ å·²å­˜åœ¨' || 'âœ… ä¸å­˜åœ¨' }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.release-management.result }}" == "success" ]; then
            echo "| Release ID | \`${{ needs.release-management.outputs.release-id }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Release URL | [${{ needs.release-management.outputs.release-url }}](${{ needs.release-management.outputs.release-url }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ðŸŽ¯ æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.version-check-and-build.outputs.is_new_version }}" == "true" ] && [ "${{ needs.version-check-and-build.outputs.tag_exists }}" == "false" ]; then
          if [ "${{ needs.release-management.result }}" == "success" ]; then
            echo "ðŸŽ‰ **å‘å¸ƒæˆåŠŸï¼**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æž„å»ºåŒ…åˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Releaseå‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.ai-changelog-generation.result }}" == "success" ]; then
              echo "- âœ… AIå˜æ›´æ—¥å¿—ç”ŸæˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸ AIå˜æ›´æ—¥å¿—ç”Ÿæˆå¤±è´¥æˆ–è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **å‘å¸ƒå¤±è´¥ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æž„å»ºåŒ…åˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Releaseå‘å¸ƒå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â„¹ï¸ **æ— éœ€å‘å¸ƒ**" >> $GITHUB_STEP_SUMMARY
          echo "- ç‰ˆæœ¬æœªæ›´æ–°æˆ–æ ‡ç­¾å·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi
