name: Edgeå•†åº—è‡ªåŠ¨æäº¤

on:
  release:
    types: [published, edited]  # ç›‘å¬å‘å¸ƒå’Œç¼–è¾‘äº‹ä»¶
  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      release_tag:
        description: "æŒ‡å®šè¦æäº¤çš„ Release æ ‡ç­¾ (å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æœ€æ–° release)"
        required: false
        type: string

permissions:
  contents: read
  actions: read

jobs:
  check-release-status:
    name: æ£€æŸ¥ReleaseçŠ¶æ€
    runs-on: ubuntu-latest
    outputs:
      should-submit: ${{ steps.check-status.outputs.should-submit }}
      release-tag: ${{ steps.check-status.outputs.release-tag }}
      download-url: ${{ steps.check-status.outputs.download-url }}    
    steps:
    - name: æ£€æŸ¥Releaseæ˜¯å¦ä¸ºLatest
      id: check-status
      run: |
        # èŽ·å–è§¦å‘äº‹ä»¶çš„releaseä¿¡æ¯
        if [ "${{ github.event_name }}" == "release" ]; then
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          
          # å¯¹äºŽç¼–è¾‘äº‹ä»¶ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦ä»Žé¢„å‘å¸ƒæ”¹ä¸ºæ­£å¼å‘å¸ƒ
          if [ "${{ github.event.action }}" == "edited" ]; then
            echo "ðŸ”„ æ£€æµ‹åˆ°Releaseç¼–è¾‘äº‹ä»¶"
            # èŽ·å–å½“å‰releaseçš„æœ€æ–°çŠ¶æ€
            CURRENT_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG")
            IS_PRERELEASE=$(echo "$CURRENT_RELEASE" | jq -r '.prerelease')
            DOWNLOAD_URL=$(echo "$CURRENT_RELEASE" | jq -r '.assets[0].browser_download_url')
          else
            DOWNLOAD_URL="${{ github.event.release.assets[0].browser_download_url }}"
          fi
        else
          # æ‰‹åŠ¨è§¦å‘æ—¶ï¼ŒèŽ·å–æŒ‡å®šæˆ–æœ€æ–°çš„release
          if [ -n "${{ inputs.release_tag }}" ]; then
            RELEASE_TAG="${{ inputs.release_tag }}"
            RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG")
            IS_PRERELEASE=$(echo "$RELEASE_INFO" | jq -r '.prerelease')
            DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[0].browser_download_url')
          else
            # èŽ·å–æœ€æ–°çš„release
            LATEST_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest")
            RELEASE_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
            IS_PRERELEASE=$(echo "$LATEST_RELEASE" | jq -r '.prerelease')
            DOWNLOAD_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[0].browser_download_url')
          fi
        fi
        
        echo "ðŸ” æ£€æŸ¥ReleaseçŠ¶æ€:"
        echo "- Releaseæ ‡ç­¾: $RELEASE_TAG"
        echo "- æ˜¯å¦é¢„å‘å¸ƒ: $IS_PRERELEASE"
        echo "- è§¦å‘äº‹ä»¶: ${{ github.event.action }}"
        echo "- ä¸‹è½½URL: $DOWNLOAD_URL"
        
        # èŽ·å–å½“å‰latest release
        LATEST_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/latest")
        LATEST_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
        
        echo "- å½“å‰Latest: $LATEST_TAG"
        
        # åªæœ‰å½“è¿™ä¸ªreleaseæ˜¯latestä¸”ä¸æ˜¯é¢„å‘å¸ƒæ—¶æ‰æäº¤
        if [ "$RELEASE_TAG" == "$LATEST_TAG" ] && [ "$IS_PRERELEASE" != "true" ]; then
          echo "âœ… Releaseå·²æˆä¸ºLatestæ­£å¼ç‰ˆæœ¬ï¼Œå‡†å¤‡æäº¤åˆ°Edgeå•†åº—"
          echo "should-submit=true" >> $GITHUB_OUTPUT
        else
          echo "â­ï¸ Releaseæœªæˆä¸ºLatestæˆ–ä»ä¸ºé¢„å‘å¸ƒï¼Œè·³è¿‡æäº¤"
          echo "- æ¡ä»¶æ£€æŸ¥: RELEASE_TAG=$RELEASE_TAG, LATEST_TAG=$LATEST_TAG, IS_PRERELEASE=$IS_PRERELEASE"
          echo "should-submit=false" >> $GITHUB_OUTPUT
        fi
        
        echo "release-tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
        echo "download-url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

  submit-to-edge-store:
    name: æäº¤åˆ°Edgeå•†åº—
    runs-on: ubuntu-latest
    needs: check-release-status
    if: needs.check-release-status.outputs.should-submit == 'true'
    
    steps:
    - name: æ£€æŸ¥å¿…éœ€çš„å¯†é’¥
      run: |
        echo "ðŸ” æ£€æŸ¥Edgeå•†åº—ç›¸å…³å¯†é’¥..."
        
        if [ -z "${{ secrets.EDGE_STORE_ID }}" ]; then
          echo "âŒ EDGE_STORE_ID æœªé…ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.EDGE_STORE_KEY }}" ]; then
          echo "âŒ EDGE_STORE_KEY æœªé…ç½®"
          exit 1
        fi
        
        echo "âœ… Edgeå•†åº—å¯†é’¥æ£€æŸ¥é€šè¿‡"

    - name: ä¸‹è½½Releaseèµ„æº
      run: |
        echo "ðŸ“¥ ä¸‹è½½æ‰©å±•åŒ…..."
        DOWNLOAD_URL="${{ needs.check-release-status.outputs.download-url }}"
        
        if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
          echo "âŒ æ— æ³•èŽ·å–ä¸‹è½½URL"
          exit 1
        fi
        
        curl -L -o extension.zip "$DOWNLOAD_URL"
        
        # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        if [ ! -f "extension.zip" ]; then
          echo "âŒ æ‰©å±•åŒ…ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        FILE_SIZE=$(ls -lh extension.zip | awk '{print $5}')
        echo "âœ… æ‰©å±•åŒ…ä¸‹è½½æˆåŠŸ (å¤§å°: $FILE_SIZE)"

    - name: éªŒè¯æ‰©å±•åŒ…
      run: |
        echo "ðŸ” éªŒè¯æ‰©å±•åŒ…å†…å®¹..."
        
        # è§£åŽ‹å¹¶æ£€æŸ¥å…³é”®æ–‡ä»¶
        unzip -q extension.zip -d temp_extract/
        
        if [ ! -f "temp_extract/manifest.json" ]; then
          echo "âŒ æ‰©å±•åŒ…ä¸­ç¼ºå°‘ manifest.json"
          exit 1
        fi
        
        # è¯»å–ç‰ˆæœ¬ä¿¡æ¯
        VERSION=$(jq -r '.version' temp_extract/manifest.json)
        NAME=$(jq -r '.name' temp_extract/manifest.json)
        
        echo "âœ… æ‰©å±•åŒ…éªŒè¯æˆåŠŸ:"
        echo "- æ‰©å±•åç§°: $NAME"
        echo "- ç‰ˆæœ¬å·: $VERSION"
        echo "- Releaseæ ‡ç­¾: ${{ needs.check-release-status.outputs.release-tag }}"
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf temp_extract/

    - name: èŽ·å–Edgeå•†åº—è®¿é—®ä»¤ç‰Œ
      id: get-access-token
      run: |
        echo "ðŸ”‘ èŽ·å–Edgeå•†åº—è®¿é—®ä»¤ç‰Œ..."
        
        # èŽ·å–è®¿é—®ä»¤ç‰Œ - ä½¿ç”¨è¡¨å•ç¼–ç æ ¼å¼
        TOKEN_RESPONSE=$(curl -s -X POST \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "client_id=${{ secrets.EDGE_STORE_ID }}&client_secret=${{ secrets.EDGE_STORE_KEY }}&scope=https://api.addons.microsoftedge.microsoft.com/.default&grant_type=client_credentials" \
          "https://login.microsoftonline.com/5c9eedce-81bc-42f3-8823-48ba6258b391/oauth2/v2.0/token")
        
        echo "è®¤è¯å“åº”: $TOKEN_RESPONSE"
        
        ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
        
        if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
          echo "âŒ èŽ·å–è®¿é—®ä»¤ç‰Œå¤±è´¥:"
          echo "$TOKEN_RESPONSE" | jq -r '.error_description // .error // "æœªçŸ¥é”™è¯¯"'
          exit 1
        fi
        
        echo "âœ… è®¿é—®ä»¤ç‰ŒèŽ·å–æˆåŠŸ"
        echo "access-token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ æ‰©å±•åŒ…åˆ°Edgeå•†åº—
      id: upload-package
      run: |
        echo "ðŸ“¤ ä¸Šä¼ æ‰©å±•åŒ…åˆ°Edgeå•†åº—..."
        
        ACCESS_TOKEN="${{ steps.get-access-token.outputs.access-token }}"
        PRODUCT_ID="lpdhbhkcbnhldcpcbocplhgeooabhbme"
        
        # ä¸Šä¼ æ‰©å±•åŒ…
        UPLOAD_RESPONSE=$(curl -s -X POST \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/zip" \
          --data-binary @extension.zip \
          "https://api.addons.microsoftedge.microsoft.com/v1/products/$PRODUCT_ID/submissions/draft/package")
        
        echo "ä¸Šä¼ å“åº”: $UPLOAD_RESPONSE"
        
        # æ£€æŸ¥ä¸Šä¼ ç»“æžœ
        UPLOAD_STATUS=$(echo "$UPLOAD_RESPONSE" | jq -r '.status // "error"')
        
        if [ "$UPLOAD_STATUS" == "Succeeded" ] || [ "$UPLOAD_STATUS" == "InProgress" ]; then
          echo "âœ… æ‰©å±•åŒ…ä¸Šä¼ æˆåŠŸ"
          OPERATION_ID=$(echo "$UPLOAD_RESPONSE" | jq -r '.id')
          echo "operation-id=$OPERATION_ID" >> $GITHUB_OUTPUT
        else
          echo "âŒ æ‰©å±•åŒ…ä¸Šä¼ å¤±è´¥:"
          echo "$UPLOAD_RESPONSE" | jq -r '.message // .error_description // "æœªçŸ¥é”™è¯¯"'
          exit 1
        fi

    - name: ç­‰å¾…ä¸Šä¼ å¤„ç†å®Œæˆ
      run: |
        echo "â³ ç­‰å¾…ä¸Šä¼ å¤„ç†å®Œæˆ..."
        
        ACCESS_TOKEN="${{ steps.get-access-token.outputs.access-token }}"
        PRODUCT_ID="lpdhbhkcbnhldcpcbocplhgeooabhbme"
        OPERATION_ID="${{ steps.upload-package.outputs.operation-id }}"
        
        # æœ€å¤šç­‰å¾…5åˆ†é’Ÿ
        for i in {1..30}; do
          echo "æ£€æŸ¥è¿›åº¦ ($i/30)..."
          
          STATUS_RESPONSE=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://api.addons.microsoftedge.microsoft.com/v1/products/$PRODUCT_ID/submissions/draft/package/operations/$OPERATION_ID")
          
          STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status // "unknown"')
          
          case "$STATUS" in
            "Succeeded")
              echo "âœ… ä¸Šä¼ å¤„ç†å®Œæˆ"
              exit 0
              ;;
            "Failed")
              echo "âŒ ä¸Šä¼ å¤„ç†å¤±è´¥:"
              echo "$STATUS_RESPONSE" | jq -r '.message // "æœªçŸ¥é”™è¯¯"'
              exit 1
              ;;
            "InProgress")
              echo "â³ ä»åœ¨å¤„ç†ä¸­..."
              sleep 10
              ;;
            *)
              echo "âš ï¸ æœªçŸ¥çŠ¶æ€: $STATUS"
              sleep 10
              ;;
          esac
        done
        
        echo "â° å¤„ç†è¶…æ—¶ï¼Œä½†ä¸ä¸€å®šå¤±è´¥"

    - name: æäº¤å®¡æ ¸
      run: |
        echo "ðŸ“‹ æäº¤æ‰©å±•åŒ…å®¡æ ¸..."
        
        ACCESS_TOKEN="${{ steps.get-access-token.outputs.access-token }}"
        PRODUCT_ID="lpdhbhkcbnhldcpcbocplhgeooabhbme"
        
        # æäº¤å®¡æ ¸
        SUBMIT_RESPONSE=$(curl -s -X POST \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"notes": "è‡ªåŠ¨æäº¤ - Release ${{ needs.check-release-status.outputs.release-tag }}"}' \
          "https://api.addons.microsoftedge.microsoft.com/v1/products/$PRODUCT_ID/submissions")
        
        echo "æäº¤å“åº”: $SUBMIT_RESPONSE"
        
        # æ£€æŸ¥æäº¤ç»“æžœ
        SUBMIT_STATUS=$(echo "$SUBMIT_RESPONSE" | jq -r '.status // "error"')
        
        case "$SUBMIT_STATUS" in
          "InReview"|"Succeeded")
            echo "âœ… æ‰©å±•åŒ…å·²æäº¤å®¡æ ¸"
            ;;
          *)
            echo "âŒ æäº¤å®¡æ ¸å¤±è´¥:"
            echo "$SUBMIT_RESPONSE" | jq -r '.message // .error_description // "æœªçŸ¥é”™è¯¯"'
            # ä¸é€€å‡ºï¼Œå› ä¸ºä¸Šä¼ å¯èƒ½å·²ç»æˆåŠŸ
            ;;
        esac

    - name: ç”Ÿæˆæäº¤æŠ¥å‘Š
      if: always()
      run: |
        echo "## ðŸª Edgeå•†åº—æäº¤æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æäº¤ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| Releaseæ ‡ç­¾ | \`${{ needs.check-release-status.outputs.release-tag }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| CRXç¼–å· | \`lpdhbhkcbnhldcpcbocplhgeooabhbme\` |" >> $GITHUB_STEP_SUMMARY
        echo "| æäº¤æ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "### ðŸŽ‰ æäº¤çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æäº¤æˆåŠŸ** - æ‰©å±•åŒ…å·²æˆåŠŸä¸Šä¼ åˆ°Edgeå•†åº—å¹¶æäº¤å®¡æ ¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **åŽç»­æ­¥éª¤:**" >> $GITHUB_STEP_SUMMARY
          echo "- Microsoftä¼šåœ¨1-7ä¸ªå·¥ä½œæ—¥å†…å®Œæˆå®¡æ ¸" >> $GITHUB_STEP_SUMMARY
          echo "- å®¡æ ¸é€šè¿‡åŽæ‰©å±•å°†è‡ªåŠ¨å‘å¸ƒåˆ°Edgeå•†åº—" >> $GITHUB_STEP_SUMMARY
          echo "- æ‚¨å¯ä»¥åœ¨ [Edgeåˆä½œä¼™ä¼´ä¸­å¿ƒ](https://partner.microsoft.com/en-us/dashboard/microsoftedge/) æŸ¥çœ‹å®¡æ ¸çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ æäº¤çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **æäº¤å¤±è´¥** - è¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:**" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æŸ¥ EDGE_STORE_ID å’Œ EDGE_STORE_KEY æ˜¯å¦æ­£ç¡®é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- ç¡®è®¤æ‰©å±•åŒ…æ ¼å¼æ­£ç¡®ä¸”é€šè¿‡éªŒè¯" >> $GITHUB_STEP_SUMMARY
          echo "- æŸ¥çœ‹Edgeå•†åº—å¼€å‘è€…æŽ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        fi

  workflow-summary:
    name: å·¥ä½œæµæ€»ç»“
    runs-on: ubuntu-latest
    needs: [check-release-status, submit-to-edge-store]
    if: always()
    steps:
    - name: ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œæ€»ç»“
      run: |
        echo "## ðŸš€ Edgeå•†åº—è‡ªåŠ¨æäº¤æ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "| ä½œä¸š | çŠ¶æ€ | ç»“æžœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| æ£€æŸ¥ReleaseçŠ¶æ€ | ${{ needs.check-release-status.result }} | ${{ needs.check-release-status.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| æäº¤åˆ°Edgeå•†åº— | ${{ needs.submit-to-edge-store.result }} | ${{ needs.submit-to-edge-store.result == 'success' && 'âœ… æˆåŠŸ' || needs.submit-to-edge-store.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŽ¯ æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.check-release-status.outputs.should-submit }}" == "true" ]; then
          if [ "${{ needs.submit-to-edge-store.result }}" == "success" ]; then
            echo "ðŸŽ‰ **æäº¤æˆåŠŸï¼**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ReleaseçŠ¶æ€æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æ‰©å±•åŒ…ä¸‹è½½æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ä¸Šä¼ åˆ°Edgeå•†åº—æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æäº¤å®¡æ ¸æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æäº¤å¤±è´¥ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ReleaseçŠ¶æ€æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Edgeå•†åº—æäº¤è¿‡ç¨‹ä¸­å‡ºçŽ°é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â„¹ï¸ **æ— éœ€æäº¤**" >> $GITHUB_STEP_SUMMARY
          echo "- Releaseæœªæˆä¸ºLatestæˆ–ä»ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- åªæœ‰Latest Releaseæ‰ä¼šè‡ªåŠ¨æäº¤åˆ°Edgeå•†åº—" >> $GITHUB_STEP_SUMMARY
        fi
